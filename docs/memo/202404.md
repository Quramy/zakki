# 4/1

## Apollo Client の `useBackgroundQuery` と Concurrent Mode

`useBackgroundQuery` は Query のトリガと描画が明示的に別の関数に分離されている。

基本的な利用方法は以下のようになる。

```tsx
function App() {
  const [queryRef] = useBackgroundQuery(query, { validables });

  return (
    <Suspense fallback={"loading..."}>
      <QueryResult queryRef={queryRef} />
    </Suspense>
  );
}

function QueryResult({ queryRef }) {
  const { data } = useReadQuery(query);
  // Render data
}
```

`variables` の内容が監視されているのは `useQuery` や `useSuspenseQuery` と同様であるが、これらの hooks と `useBackgroundQuery` がことなるのは、 `useBackgroundQuery` を実行した Component そのものはサスペンドしない、ということ。サスペンドするのは、あくまで `queryRef` を受け取って `useReadQuery` を実行するコンポーネントである。上記の例では `QueryResult` コンポーネントが相当する。

例えば Variables の中身に `<input type="text">` 由来の検索キーワードがある場合、タイプの度に Query が飛んで `QueryResult` がサスペンドするが、 https://react.dev/reference/react/Suspense#showing-stale-content-while-fresh-content-is-loading と同じテクニックを利用できる。

```tsx
function App() {
  const [queryRef] = useBackgroundQuery(query, { validables });
  const deferredQueryRef = useDeferredValue(queryRef);

  return (
    <Suspense fallback={"loading..."}>
      <QueryResult queryRef={deferredQueryRef} />
    </Suspense>
  );
}

function QueryResult({ queryRef }) {
  const { data } = useReadQuery(query);
  // Render data
}
```

## RSC における `react-server` Condition

package.json に React Server 用の Conditional Import 書いたら Static Differential Loading できた。

```json
{
  "imports": {
    "#util": {
      "react-server": "./src/util.react-server.ts",
      "default": "./src/util.default.ts"
    }
  }
}
```

軽くまとめて Medium に投稿した。

https://quramy.medium.com/server-component-%E3%81%A8-client-component-%E3%81%A7%E4%BE%9D%E5%AD%98%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%92%E5%88%87%E3%82%8A%E6%9B%BF%E3%81%88%E3%82%8B-7d65c8b2074f
