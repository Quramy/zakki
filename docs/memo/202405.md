# 5/2

## reg-suit のメンテと GCP

自分のクレカ更新したときに Google の課金情報を更新するのを忘れていたせいで、抱えている GCP Project のいくつかが停止されていた。
このせいで、reg-suit の開発用に使っている GCS にアクセスできなくなり、CI が全落ちしていて reg-suit の Deploy に支障をきたしていたため、アカウントを正常化して Fail していたいくつかの PR を re-run した。

---

# 5/7

## Excalidraw

いわゆる Miro のような UI を OSS として切り出したパッケージ。

https://docs.excalidraw.com/

Canvas にアクセスする コアな部分は [Rough.js](https://roughjs.com) を利用していて、エディタ部分などを React で実装している。

---

# 5/8

## microCMS と fetch failed

Node.js で miscro-cms-sdk 使っている箇所で `Network Error. Details: TypeError: fetch failed` だけのログが Error Tracking されていて先に進めなくなる問題。
大方 `getaddrinfo` で DNS が詰まったとかその手の問題だとは思うのだけど、裏を取ろうにも caused by が一切表示されないのは困る。

https://github.com/microcmsio/microcms-js-sdk/issues/82

## Colocated fragment stub

Apollo Client もしくは graphql-codegen で `useFragment` している Component のテストを考えると「`makeFragmentData` に食わせるスタブデータをどう作成・管理していくか」というネタに行き着く。

「データは Component と対で管理する」が大原則なわけだから、スタブデータも Component のディレクトリに配置したいし、`useFragment` がネストしているのであれば、Query が Compose されるのと同じように、スタブデータも Composition したい。

以前に、自前で スタブデータ用の factory を自前で作って Compose するような構成を採用したことがある。

```ts
// components/ChildComponent/stub.ts

import type { DocumentType } from "~/gql";
import type { childFragmentDocument } from ".";

export const getChildFragmentData = () => {
  const data = {
    // データ
  } satisfies DocumentType<childFragmentDocument>;
  return data;
};
```

```tsx
// components/ChildComponent/index.stories.tsx

import type { Meta, StoryObj } from "@storybook/react";
import { ChildComponent } from ".";
import { getChildFragmentData } from "./stub";

const meta = {
  title: "ChildComponent",
  component: ChildComponent,
} satisfies Meta;

type Story = StoryObj<typeof meta>;

export const Default = {
  args: {
    data: getChildFragmentData(),
  },
} satisfies Story;
```

```ts
// components/ParentComponent/stub.ts

import type { DocumentType } from "~/gql";
import { getChildFragmentData } from "~/components/ChildComponent/stub";
import type { parentFragmentDocument } from ".";

export const getParentFragmentData = () => {
  const childFragmentData = getChildFragmentData();
  const data = {
    child: childFragmentData,
    // データ
  } satisfies DocumentType<parentFragmentDocument>;
};
```

```tsx
// components/ChildComponent/index.stories.tsx

import type { Meta, StoryObj } from "@storybook/react";
import { ChildComponent } from ".";
import { getParentFragmentData } from "./stub";

const meta = {
  title: "ParentComponent",
  component: ParentComponent,
} satisfies Meta;

type Story = StoryObj<typeof meta>;

export const Default = {
  args: {
    data: getParentFragmentData(),
  },
} satisfies Story;
```

上記における stub.ts の部分が自前の factory であり、 https://www.mizdra.net/entry/2023/09/28/174037 における以下に相当している。

> ダミーレスポンスを作成する補助関数 (factory みたいなやつ) を自作している人が多いんじゃないかと思います。

mizdra さんと自分でスタンスが異なるところがあるとすると、mizdra さんは GraphQL の Type(Schema) に対する factory を考えて、自分は Fragment(Operation) に対する factory を考えているという点。

ただ、Fragment は Type を特化した型でしかないので、Type Factory のヘルパがあれば自分のユースケースは原理的には満たせるはずだけど、いずれにせよ触って確かめてみたほうがいいだろうな。
