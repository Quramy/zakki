# 8/1

## TypeScript 型パズル で `DeepPick`

microCMS の SDK で GET 系の API を実行する場合、 オプションの `fields` で取得するフィールドを限定できる。

ref: https://document.microcms.io/content-api/get-list-contents#h7462d83de4

```ts
import { createClient } from "microcms-js-sdk";

const client = createClient({
  apiKey: "*******",
  serviceDomain: "myapp",
});

type BlogPost = {
  id: string;
  title: string;
  body: string;
  tags: {
    label: string;
  }[];
};

const results = await client.getAllContents<BlogPost>({
  endpoint: "posts",
  queries: {
    fields: ["id", "tags.label"],
  },
});
```

ただし `fields` を使ったとしても結果の型は `getAllContents` の型パラメータで指定したものと一緒になってしまう。
上記の例の場合、 `results` の型は依然として `BlogPost[]` のまま、という意味。

本当に欲しい型は以下のような絞り込まれた形。

```ts
type ActualResultType = { id: string; tags: { label: string }[] }[];
```

`fields` は `"tags.label"` のようなドット繋ぎの形式も許容されるため、 TypeScript 組み込みの `Pick` 型だと充足できないため、再帰的な Pick を作る必要があるため、久々に型パズルしてみた。

https://gist.github.com/Quramy/d2a3b6eb5a5edf469fea0546f1118561#file-index-ts

サンプルは以下のような感じ。

```ts
type BlogPost = {
  id: string;
  isDraft: boolean;
  title: string;
  subTitle?: string;
  body: string;
  author?: {
    id: string;
    firstName: string;
    lastName: string;
    createdAt: string;
    updatedAt: string;
  };
  tags?: {
    id: string;
    color: string;
    label: string;
    createdAt: string;
    updatedAt: string;
  }[];
  createdAt: string;
  updatedAt: string;
};

const testObj: DeepPick<
  BlogPost,
  "id" | "author.id" | "author.firstName" | "tags.label"
> = {
  id: "b0001",
  author: {
    id: "user001",
    firstName: "Bob",
  },
  tags: [{ label: "Programming" }, { label: "TypeScript" }],
};

// @ts-expect-error
type WithInvalidPath = DeepPick<BlogPost, "id" | "not_existing_key">;
```

`DeepPick` の第２パラメータについて、組み込みの `Pick` 型と同じく利用可能なフィールドのみに限定するようにしたわけだが、つい今週にまったく違う文脈でも「Record から再帰的に `.` や `[]` をトークンとした Path を構成する」というのをやろうとしたばかり。
React Hook Form だったり、JSON Path だったりでこのような要求は意外とあるものなんだけど、この手の型パズルじみたコードを書けるようなるために必要な知識を Step by Step で伝達するの、どうすると効率的なのやら。
