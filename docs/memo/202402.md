# 2/1

## Testing

web.dev にフロントエンド向けのテストのセクションが追加されていたので、ざっと目を通していた。

https://web.dev/learn/testing/welcome

新しい学びがあるというわけではないが、英語における言葉選びをするときの参考にはなりそう。

具体でいうと、VRT っていってるけど、Visual Test としか書いていない。
逆に自動テスト全般を指して Regression Test と呼んでいる。

自動で画像のテストを行うのだから、僕自身の VRT という言葉の使い方は合っているとは思うんだけど。

---

# 2/2

## Figma

Dev mode が 1/31 で無料期間終了したので、改めて Dev mode と通常の閲覧の違いを眺めていた。

https://help.figma.com/hc/en-us/articles/20652568757399-What-s-coming-after-the-Dev-Mode-beta#h_01HMY86NP7CMGTKDVH437S922W

Dev mode で一番ありがたかったの、hover するだけでインスペクションが表示される、という点程度で、正直他の機能は全然使っていなかった。

オブジェクト間の距離を測るのは自分の中では必須なんだけど、久しぶりに Dev mode 解除して使ってみようとしたら、Option キー押しながら、となっていたんだけど、これ昔からそうだったっけ？

https://help.figma.com/hc/en-us/articles/360039956974-Measure-distances-between-layers

## TypeScript

たまたま `tsc --lib DOM` をつけるような行為があったので、ふと https://common-min-api.proposal.wintercg.org/ に定義されているような API が `lib.dom.d.ts` のままでいいのか？と思って TypeScript 本体の Issue 探したが、それらしい Discussion は見当たらず。
`fetch` を Node.js から使いたいのに `--lib DOM` はおかしくね？と思わないでもない。

---

# 2/6

## TypeScript

5.4 beta の blog を眺めていたら、Deprecated な Options についての勧告が目に入る。

https://devblogs.microsoft.com/typescript/announcing-typescript-5-4-beta/#upcoming-changes-from-typescript-50-deprecations

5.5 以降ではここで紹介されているような、といっても `--target es3` とかのレベルではあるが、オプションは利用不可能になる。

## JavaScript

TC39 に Stage 2.7 という中間ステージが爆誕したらしい。

https://blog.jxck.io/entries/2024-02-06/tc39-stage-2.7.html

## Tauri

[Publickey のエントリ](https://www.publickey1.jp/blog/24/electrontauri_v2iosandroid.html) が TL に流れてきたのが目に入り、 Tauri というフレームワークの存在を知る。

https://beta.tauri.app/

Yet Another Electron 的なものらしい。

---

# 2/7

## Plasmo

Plasmo における CSUI のファイル設置ルールのせいで時間溶かした。

関係する PR / issue は下記:

- https://github.com/PlasmoHQ/plasmo/issues/613
- https://github.com/PlasmoHQ/plasmo/pull/657

自分はてっきり、Next.js の Pages Router のように、「`src/contents/**/*.tsx` に該当する全てのファイルが Content Script として扱われる」だと思いこんでいたが、実は違った。

以下は PR657 の Description に記載されているツリーサンプルだが、このサンプルにおいて、CSUI として扱われるのは `valid-script.ts` と `another-valid-script/index.tsx` **のみ** 。

```
src
└── contents
    ├── another-valid-script
    │   ├── utils.ts
    │   └── index.tsx
    └── valid-script.ts
```

ここまではまぁギリ想像つくんだが、 `contents/yet-another/valid/index.tsx` のような、Deep Nested なディレクトリを切っても探索されない。

[Docs](https://docs.plasmo.com/framework/content-scripts#adding-multiple-content-scripts) にはそんなことは一言も触れられていないし、https://github.com/PlasmoHQ/examples/tree/main/with-many-content-scripts/contents/nested という名前を見たら「ネストできるのね」と思うのでは...?

issue 613 にも「Next.js とは違って」的な趣旨のコメントはあるけど、Next.js や Remix に慣れている側からしたら初見殺しでしかなくないか？これ。

## Vite

https://twitter.com/prisma/status/1754895278933418419

Prisma が Vitest のスポンサーになったらしい。

## Next.js

たまたま TL を見ていたら目に入ったポッドキャストがかなり面白かった。

https://open.spotify.com/episode/0qGAUQVeQR21BNMo5HvK3V

> サイフロ通信の#7 では、サイボウズ Office の技術刷新プロジェクトである DOGO プロジェクトから西谷さん、野原さん、 @mugi_uno の 3 人をゲストに、Next.js の App Router を使ったフロントエンド刷新の話を根掘り葉掘り聞いてみました。

以下聴きながらとった :memo:

- サイボウズ Office は創業時 20 年前からある
  - ところどころでスタックが異なるが、色々な負債が溜まっている
    - e.g. C++, 独自スクリプト言語...?
- DOGO はこれの刷新を行うプロジェクト
  - フロントエンドは Next.js App Router
- Next.js App Router について
  - 採用確定は発表直後 (2022.11 時点, 要するにベータ)
    - プロジェクト自体は、2022 年の 3 月ころから動き出していたらしい
    - 最初の選択肢は 2 つ (React.js は確定している)
      - 所謂 SPA 案(kintone がそう)
      - SSR アリのパターン
    - React Core チームが Server Side に向いていることが切欠(e.g. 2020 年末の RSC の発表など)
    - サイボウズ Office は静的な部分が多め(多分歴史が古いことも関係していそう)
    - 最初は Remix を検討していた
      - が、Next Conf '22 で RSC 周りの news がありそうだったので、決定を先延ばしに
- リリース戦略
  - ビッグバンリリースはしていない
  - ページ単位でのリリース
    - MPA のページを１つずつ置き換え
  - Percentage Rollout(App Router 版は最初 5% 程度から少しずつ上げていく)
    - カナリアリリースには neko(?) という名称の社内の DevOps 基盤で実現している
    - カナリアで不具合を検知できているのか？
      - 不具合を何度か見つけて修正している
    - リリース行為に対する心理的障壁が下がっている
      - 定期リリースだと、与えられたバッファを食いつぶして待っていたかも
- 移行の進捗について
  - サイボウズ Office の小さい一つ(名前は聞き取れず) は順調にリリースできた
  - ここからは大物が待ち構えている...!
- Q&A コーナー
  - 1. App Router を採用した開発を振り返って
    - 西谷さん
      - 思ったより困らなかった
      - SA がシンプルに書ける. Mutation 周りを今までよりもシンプルに書けていると感じる
    - 野原さん
      - あんまり困っていない. 元のアプリケーションが古典的な MPA であったため、ブラウザ側に複雑さが少なめ
      - Next.js や React のコードは適宜読むようにしている
      - 周囲の人が積極的に技術をキャッチアップしているからあまり困っていない
      - チームで Next.js Doc を一通り読む会を行ったりした. Doc 会では Cache 周りの節が一番記憶に残っている
    - mugi さん
      - MPA からの移行の相性はよい (JS Conf のときと意見変わらず)
        - 「サーバーサイドで HTML + ブラウザで jQuery などで一部書き換え」のメンタルモデルに近い
        - 逆に Pages Router からの置き換えの方がメンタルとしては遠そう
  - 2. 大規模なフロントエンド刷新について. どうしても長期的(対象が百ページの単位) になるが、モチベーションなどどう捉えているか？
    - 西谷さん
      - 「新しい機能を世の中に出す」という喜びが味わえない点に課題感がある
      - 刷新したフロントエンド基盤(App Router) で新機能も作ってみることを 2024 年の目標にしている
    - 野原さん
      - 「どうやって期間を短縮するか？」について頭を回している
        - e.g. 刷新前の機能を移行しないという判断をどうやって上手くやるか. 積極的に機能を簡略するようにしている. ビジネス側への相談は持ち込みやすい
    - mugi さん
      - 刷新プロジェクトを立ち上げないといけないこと自体が不健全
  - 3. 今悩んでいることは？
    - 西谷さん
      - 今は全部 Cache 切っていて活用できてない. 使うとなったら色々考えること多そう
      - セルフホストであること自体は Custom Cache Handler で何とかできそうと思っているが、Cache の要件は気にしている
    - 野原さん
      - テスト周りがなやみ
        - Integration Test は Backend Container 立ち上げているので、CI 速度などが問題になりそうと思っている
        - どこまでテスト書こうかな、も悩み中
    - mugi さん
      - 世の中の App Router の風当たりが...w
        - 世間が Remix に心奪われてる(でも SPA モードにはサイボウズ Office にはマッチしないし)
      - もうちょっと事例出てくると嬉しい

:memo: はここまで

全体通して「(部分的であっても) プロダクトにきちんとリリースした人達の感想だな」という所感。
というか、プロジェクトのコンテキストは異なるが、自分が一段落を迎えたときに振り返った感想と驚く程似通っている。
「リスクを避けつつ本番まで持っていこうとすると現時点ではこうしかならない」というポイントがいくつかあって、サイボウズも自分とこもそこに収束してるんだろうな。
