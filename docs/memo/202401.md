# 1/9

## SWR

swr と Tanstack Query の違い

https://www.ai-shift.co.jp/techblog/3680

個人的には以下が一番衝撃。。。

> SWR では TanStack Query のようにキャッシュの生存期間を設定するオプションはありません。基本的にキャッシュの自動再検証は以下のタイミングで行われます。（これらのオプションは TanStack Query にも共通します。）

## Prisma

Prisma で検索や挿入をする際に、戻り値の SELECT を確実に指定するように強制するような ESLint のプラグインってないのかしら。

React の Taint API と同じ文脈であるが、 `findUser` で取得した JSON がうっかり Client Component に渡ると、User Table の全ての列が RSC Payload に乗ることになる。

```ts
export async function findUser(id: string) {
  return await prisma.user.findUnique({
    where: {
      id,
    },
  });
}
```

```tsx
"use client";

export function User({ user: { name } }: { user: { name: string } }) {
  return <div>{name}</div>;
}
```

上記の例であれば、それこそ React の Taint を使えば防御はできるが、そもそもが `taint` の利用を忘れたら意味がないので、別の防御手段も考えておきたい。

```ts
export async function findUser(id: string) {
  const user = await prisma.user.findUnique({
    id,
  });
  taint("Don't pass this object to clinet component", user);
  return user;
}
```

Prisma の API 実行時点で SELECT する対象を明示するようにできれば、事故防止になるんじゃないか？という発想。

```ts
export async function findUser(id: string) {
  return await prisma.user.findUnique({
    select: { name: true },
    where: {
      id,
    },
  });
}
```

適当に "prisma eslint plugin" などで検索してみたが、それっぽいものは見つからず。

## Accounts.js

The Guild の Blog を巡回している最中に見つけた。

https://the-guild.dev/blog/accounts.js-1.0-rc

Alt Passport 的な感じのライブラリかしら？

## Misc

2 週間程度休んでいたので、今日から仕事はじめ。

---

# 1/10

## prisma-fabbrica

昨年末に起票された https://github.com/Quramy/prisma-fabbrica/issues/244 について、やはり Transient Attributes と似た機能を要求されているように思える。

Transient attr と呼ぶべきか、Contextual Parameters と呼ぶべきかはさておき、「Factory 側から参照できる任意の変数を定義したい」ということなのかな。
型定義が複雑になるだろうから、要望があるまでは考えないようにしていたけど、正面から向き合うべきときが気たのかもしれぬ。

---

# 1/11

## prisma-fabbrica

昨日に引き続き、https://github.com/Quramy/prisma-fabbrica/issues/244 について。

任意の引数を与えるための関数シグネチャとして、以下を考えていた。

```ts
type Context = {
  hoge: boolean;
};

const UserFactory = defineUserFactory<Context>({
  defaultData: async (_, { hoge }) => {
    return {
      someRelated: await OtherFactory.build({ hoge }),
    };
  },
});

await UserFactory.create({ hoge: true });
```

これを実現するための型定義がそんなに簡単ではないことに気づく。

```ts
// AS-IS
declare function defineUserFactory<TOptions extends UserFactoryDefineOptions>(
  options: TOptions
): UserFactoryInterface<TOptions>;

// Invalid type declaration because required type parameter TOptions isn't allowed after optional type parameter TContext
declare function defineUserFactory<
  TContext = {},
  TOptions extends UserFactoryDefineOptions
>(options: TOptions): UserFactoryInterface<TContext, TOptions>;

// The following is valid declaration. But defineUserFactory<Context> means "Set `Context` as type parameter `TOptions`(not `TContext`)".
declare function defineUserFactory<
  TOptions extends UserFactoryDefineOptions,
  TContext = {}
>(options: TOptions): UserFactoryInterface<TContext, TOptions>;

// If signature was overloaded and TContext was set as required, developer couldn't call defineUserFactory<Context> because lacking `TOption`.
declare function defineUserFactory<
  TContext,
  TOptions extends UserFactoryDefineOptions
>(options: TOptions): UserFactoryInterface<TContext, TOptions>;
declare function defineUserFactory<TOptions extends UserFactoryDefineOptions>(
  options: TOptions
): UserFactoryInterface<{}, TOptions>;

// The following signature is valid, but trait keys are infered as `never`.
declare function defineUserFactory<
  TContext,
  TOptions extends UserFactoryDefineOptions = UserFactoryDefineOptions
>(options: TOptions): UserFactoryInterface<TContext, TOptions>;
declare function defineUserFactory<TOptions extends UserFactoryDefineOptions>(
  options: TOptions
): UserFactoryInterface<{}, TOptions>;
```

https://github.com/Quramy/prisma-fabbrica/issues/252 に清書したが、デフォの Context 値から推論させることも考えたが、これはこれで HOF に頼らざるを得ないあたりが悩ましい。

---

# 1/12

## SWR

SWR における `mutate()` は Revalidate の意味もあるのか。。

https://swr.vercel.app/docs/mutation#revalidation

## prisma-fabbrica

一旦脳死で作れる callback の方だけ実装着手。

https://github.com/Quramy/prisma-fabbrica/pull/254

ただ、parameter の方も無いと旨味少ない気がするので、Release はしばらくせずに寝かせておくか。
