# 11/1

## Change Data Capture

DB の同期を取るような文脈で CDC という略語があることを知った。

## Netlify と OpenNext

https://www.netlify.com/blog/netlify-joins-opennext

## RSC Payload と `AsyncIterable`や `ReadableStream`

React 側では https://github.com/facebook/react/pull/28847 で RSC ペイロードに `ReadableStream` と `AsyncIterable` を渡せるようになっている。
この PR の Merge タイミングが 2024.04.17 なので、 React v19 RC には乗っているのだと思う。

Next.js の v15 Stable に伴って、この機能も使えるようになったことになる。

Next.js の 14.x 系 Stable は React 19 を取り込まなかったからなのか、v14.2.16 などで試すと以下のエラーメッセージが出る。

```
Only plain objects can be passed to Client Components from Server Components. Objects with symbol properties like Symbol.asyncIterator are not supported.
```

これ、利用する機会あるんかなー。

`AsyncIterator` 使えるということは、ちょっとずつ SC を generate するようなことが原理的にはできそうだけど、React のコードとしてそれってどう書けばいいんだ？

sebmarkbage が PR Description で書いている以下部分もよくわからんし。

> AsyncIterables can also be returned as children of Server Components and then they're conceptually the same as fragment arrays/iterables. They can't actually be used as children in Fizz/Fiber but there's a separate plan for that.

## Web Stream API

RSC Payload に Readable Stream が使える、というのに付随して、そもそも Web Stream API ってなんだっけ、、、となった。

そういえば Web 標準に Stream があるらしい、というのは聞いてたけど、触ったことが一回も無かった。

とりあえず、Node.js で Web Stream をゴニョゴニョする話については、結構前に `@yosuke_furukawa` 会長が発表していたので、これを読む。

https://speakerdeck.com/yosuke_furukawa/whatwg-stream-falsehua

---

# 11/6

## Next.js と i18n

おしごとで i18n 対応が発生しそうな気配を察したので、軽く下調べ。

https://www.npmjs.com/package/i18next というライブラリの趨勢が強そうなので、まずはこいつを素振りする。

Next.js に組み込むには https://github.com/i18next/next-i18next というアダプタがあるにはあるのだが、こいつは完全に Pages Router 専用らしい。

App Router については https://locize.com/blog/next-app-dir-i18n/ で方法が紹介されている。

掻い摘んで書くと、

- SC と CC で `useTransalation` を別物として定義する
  - SC 用: react-i18next の `useTransalation` に Signature を似せた async 関数
  - CC 用: react-i18next が提供する `useTransalation` hook を少しラップして SSR 対応を入れたバージョン

いずれも、以下のような感じで使わせる想定。

```tsx
// SC の場合

import { useTranslation } from "@/lib/i18n";

export async function AwesomeComponent({ lng }: { lng: string }) {
  const { t } = await useTranslation(lng, "awesome-component");
  return (
    <>
      <h1>{t("title")}</h1>
    </>
  );
}

// CC の場合
("use client");

import { useTranslation } from "@/lib/i18n/client";

export async function AwesomeComponent({ lng }: { lng: string }) {
  const { t } = useTranslation(lng, "awesome-component");
  return (
    <>
      <h1>{t("title")}</h1>
    </>
  );
}
```

https://github.com/i18next/next-app-dir-i18next-example-ts に完品のコードがあったので、これを真似しつつやってみた。

https://github.com/Quramy/next-js-i18n-example

ほぼ locize の Blog 通りではあるが、言語ごとのリソースを Collocate するように変更してみた。

```
src/app
├── [lng]
│   ├── _components
│   │   └── Footer
│   │       ├── index.locale.en.json
│   │       ├── index.locale.ja.json
│   │       └── index.tsx
│   ├── globals.css
│   ├── layout.tsx
│   ├── page.locale.en.json
│   ├── page.locale.ja.json
│   ├── page.tsx
│   └── second-page
│       ├── page.locale.en.json
│       ├── page.locale.ja.json
│       └── page.tsx
└── i18n
    ├── client.ts
    ├── index.ts
    └── settings.ts
```
