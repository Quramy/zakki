# 3/1

## zakki の見出し再考

何の気なしに、このレポジトリの memo の数を調べてみようと思い、以下のコマンドを実行した。

```sh
find docs/memo | xargs grep "^## "
```

上記の行数を取ったら、1,340 だった。

数は正直どうでもよくて、このコマンドの出力が以下のようになっていて、見出しとしての役割をあまり果たしていない気がしてきた。

```
:
docs/memo/202308.md:## CSS
docs/memo/202308.md:## Misc
docs/memo/202308.md:## CSS
docs/memo/202308.md:## Misc
docs/memo/202308.md:## CSS
docs/memo/202308.md:## Stylelint
docs/memo/202308.md:## Vim
docs/memo/202308.md:## CSS
docs/memo/202308.md:## VSC
docs/memo/202308.md:## recast
docs/memo/202308.md:## GraphQL Tokyo
docs/memo/202308.md:## Web Assembly
docs/memo/202308.md:## Misc
docs/memo/202308.md:## Performance
docs/memo/202308.md:## Web
docs/memo/202308.md:## Next.js
docs/memo/202209.md:## Unix
docs/memo/202209.md:## Jest
:
```

気になりだして、2020 年 9 月分から、再度見出しをつけ直し始めたものの、中々の重労働。1,300 あるので、それはそうなんだけど。

400 個見直すのに、2 時間程度使っている気がする。

## reg-cli / reg-suit と polyfill.io

自分にはあまり関係のない話と思っていた polyfill.io の件、reg-cli の UI Report で使っていたことを唐突に思い出して、修正した。

その過程で @bokuweb さんと Secure by default の考え方について色々と話す。

https://yosuke-furukawa.hatenablog.com/entry/2023/01/12/160406 の話もしたり。

> Node.js はエコシステムが既にあります。このエコシステムを壊すことはできないため、既に存在する機能に対してオプトインする（後から付け加える）形で導入する必要があります。(この点、 Deno などの後発は Secure By Default としてデフォルトからセキュア側に倒す事もできる設計になっていますし、Deno は実際にそうなっています。)

## TypeScript の `DocumentRegistry` 再考

DocumentRegistry は Language Service に対して、 Source File の供給を担う抽象化層。
Language Service が ts の Project に対して 1:1 になるのに対して、DocumentRegistry は Project に対して多対一の関係。

```ts
const documentRegistry = ts.createDocumentRegistry();
const languageService = ts.createLanguageService(
  languageServiceHost,
  documentRegistry
);
```

主なイベント (Language Service 側から利用されるメソッド) は acquire, update, release の 3 種.

- acquire: ファイル名を key にして、Source の AST を返却する. Language Service がファイルを要求するときに動作する
- update: ファイル名を key にして AST の update を行う。裏側では Incremental Parse が動作する？
- release: DocumentRegistry からファイルを破棄する際に呼び出される？ファイルシステムから対象ファイルを削除したことを Language Service が検知した場合に利用する？

---

# 3/4

## img-diff-js のレポジトリメンテナンス

放置気味だった img-diff-js のメンテを行う。

- yarn v1 剥がし
- CI の Node.js 最新化
- renovate の auto merge 有効化
- dependencies upgrade
- performance テスト廃止 (別の npm package と性能比較していたが、古すぎて参考にならなくなっていたため)
- Codecov 追加

## zakki の見出し再考

2021.04, 2021.05 分の h2 見出しを見直した。

## PicoML に CodeCov 導入

折角なので入れてみた。 93% 。これもテスト一杯書いたなぁ。。

---

# 3/5

## Sentry と CodeCov

たまたま、CodeCov と Setnry の UI の両方を眺める機会があって気づいたけど、 CodeCov っていつの間にか Sentry 傘下に入った？

## ts-graphql-plugin の Global Fragment Registry

Language Service の Auto Completion / Diagnostics どちらも、対象となるオペレーションを解析させる時点で「グローバルにどのような Fragment が定義されているか」が判明している状態でないとならない。

そこで、以下の方針で Fragment Map を取り扱うことを考える。

1. `ts.DocumentRegistry` にて、Script File の Open や Update を見張っておき、投機的に Fragment の map を準備しておく
1. 解析時は、事前に準備済の Fragment Map を参照する

特に 2. について、最初は graphql-language-service の `getFragmentDependencies` を使って力技気味に実装することを考えていたが、`getAutocompleteSuggestions`, `getDiagnostics` ともに、オプショナルな引数として `FragmentDefinitionNode[]` を受け取るようになっていたので、これを用いることで実装の目処が立ってきた。

```ts
const externalFragments: FragmentDenitionNode[] = fragmentDefenitionNodes;

getDiagnostics(queryDocument, schema, undefined, undefined, externalFragments);
```

ただ、細かく不都合が出てきていて、上記における解析対象の `queryDocument` が以下の Source 上の Document であったとして、この `MyFragment` の定義は `externalFragments` に含めてはいけないようになっていた。

```tsx
const MyFragment = gql`
  fragment MyFragment on User {
    name
  }
`;
```

一旦、Language Service 側が一通り動作するところまで仕上げた。

https://github.com/Quramy/ts-graphql-plugin/pull/1209
