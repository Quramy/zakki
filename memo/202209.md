# 9/1

## Unix

仕事で BigQuery から CSV を引っこ抜いてきて、別の CSV と突き合わせて諸々調査する、というのをやっていたのだが、最終的なスクリプトに食わせる中間的な操作はコマンドだけで済ませたいく、頻繁に使えそうなものをピックアップしてみた。

ヘッダ行の退避:

```sh
head -n 1 raw.csv > header.csv
```

データ部分の取り出し:

```sh
tail -n +2 raw.csv > data.csv
```

処理したデータとヘッダ行の結合

```sh
cat processed_data.csv | cat header.csv -
```

2 列目を辞書順でソート:

```sh
sort -t, -k2 data.csv
```

3 列目を数値順でソート:

```sh
sort -t, -k3n data.csv
```

2 列目を辞書順、さらにその中で 3 列目を数値順でソート:

```sh
sort -t, -k2,2 -k3n,3 data.csv
```

4 列目のみを取り出し:

```sh
cut -d, -f 4 raw.csv
```

1 列目と 3 列目を取り出し:

```sh
cut -d, -f 1,3 raw.csv
```

4 列目を重複排除して表示:

```sh
sort -t, -k4 raw.csv | cut -d, -f 4 | uniq | cat -n
```

4 列目を重複排除した数を取得:

```sh
sort -t, -k4 raw.csv | cut -d, -f 4 | grep -v "^$" | uniq | wc -l
```

---

# 9/5

## Jest

SuperTest / msw を初めて併用した。

Node.js + Express な Service の Integration Test パターン。

msw 側が SuperTest の対象の request について「それ、mock handler すり抜けるけど大丈夫？」的な Warning を jest に履いてきて地味に鬱陶しい。 https://github.com/mswjs/msw/issues/191 でも言及されているが、解決策部分は Outdated。

```text
  console.warn
    [MSW] Warning: captured a request without a matching request handler:

      • POST http://127.0.0.1:36489/api/foo/

    If you still wish to intercept this unhandled request, please create a request handler for it.
    Read more: https://mswjs.io/docs/getting-started/mocks
```

msw の `onUnhandledRequest` を使って解決できたので、Medium に tips 記事を残しておいた。

https://quramy.medium.com/supertest-%E3%81%A8-msw-%E4%BD%B5%E7%94%A8%E6%99%82%E3%81%AB-warning-log-%E3%82%92%E6%8A%91%E6%AD%A2%E3%81%99%E3%82%8B-430709dab48c

---

# 9/6

## AWS

久しぶりに CloudWatch Logs Insight を使う機会があったので、改めてクエリの構文を見直し。

Syntax レベルの話であれば、 https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html を見れば大体思い出せそう。

CWLogs の場合、Query 本体の中には対象のロググループの識別子が含まれないので、よく使うロググループとクエリのペアについては Saved Query に突っ込んでおくのが吉。

---

# 9/7

## GitHub

GHA で AWS や GCP などに連携するときに、CI 用の Secret (SA json) を直接焼き込むのではなく、OIDC で発行されたユーザーに対してロールを割り当てることができる。

https://zenn.dev/mryhryki/articles/2021-09-19-access-aws-by-github-actions の解説が詳しい。

GHA が OIDC プロバイダになっていて、GitHub 側が認証したユーザーに対して、AWS などの側で認可する形式になる。

---

# 9/9

## Next.js

https://nextjs.org/blog/next-12-3

`swcMinify` が安定化したらしい。

社内で会話したところ、 `swyMinify` は トランスパイラとしての `@swc/core` とは直接的な関係はなく、 SWC Organization で作られている minifier の名称。

SWC 的には `swcpack` というバンドラ層のツールもあるみたい。

https://swc.rs/docs/usage/bundling

Next.js がすべての build chain を `@swc` に寄せることはあるんだろうか？というのは興味がある。
