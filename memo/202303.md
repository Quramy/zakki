# 3/1

## EKS

IRSA (IAM Role Service Account) について。

https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/iam-roles-for-service-accounts.html

EKS 上で稼働しているコンテナに、AWS リソースへのアクセスを認可するための手法。

> サービスアカウントの IAM ロールには、Amazon EC2 インスタンスプロファイルから Amazon EC2 インスタンスに認証情報を提供する場合と同じような方法で、アプリケーションの認証情報を管理する機能があります。AWS 認証情報を作成してコンテナに配布したり、Amazon EC2 インスタンスのロールを使用する代わりに、IAM ロールを Kubernetes サービスアカウントと関連付けて、サービスアカウントを使用するようにポッドを設定することができます。

- Deployment に Pod に紐付ける Service Account を用意する
  - Service Account 自体は kubernetes 側の機能
  - https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/
- 紐付ける Service Account の annotation として、IAM Role を ARN で指定する

---

# 3/2

## GitHub Actions

以前にも一度調べたことがあるが、GHA から AWS を利用させるケースについて、IAM ユーザーを用意するのではなく、GitHub を IdP として、外部ユーザーに自分の AWS アカウントの利用許可を与えるパターンの実装方法について、もう一度調べた。

- workflow は、workflow 実行者の GitHub における認証情報を ID Token に書き出しておく
- GitHub IdP とした AWS OIDC Provider を設定しておく.
  - 設定時は、GitHub の JWK Set Document URL から thumbprint を用意して IdP 署名検証局情報を設定する(https://logmi.jp/tech/articles/322839#s4)
- workflow は ID token を AWS STS に渡して、一時的な AWS の認証セッションを得る
- AWS STS の認証情報に対して、IAM Role を紐付けることで、workflow は STS 経由で取得した認証セッションの中で IAM Role で規定された Resource にアクセスが行える

参考にした AWS 関係の Document は以下:

- https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_credentials_temp.html
- https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_roles_providers_create.html
- https://github.com/aws-actions/configure-aws-credentials
