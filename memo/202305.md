# 5/8

## webmock

RSpec + webmock で多少複雑な stub が必要になったことを切欠に webmock の実装を同僚と読み漁った結果、webmock と `RSpec::Mocks::ArgumentMatcher` の関係が大分理解できた。

折角なので Medium にエントリ書いた。

https://quramy.medium.com/webmock-%E3%81%A8-argumentmatcher-f1b48dd2174e

Ruby のネタ上げるの、初めてかも。

---

# 5/12

## Next.js

https://nextjs.org/blog/next-13-4

## Node.js

Async Local Storage の Document がいつの間にか Async hooks から飛び出ててた。

https://nodejs.org/api/async_context.html#class-asynclocalstorage

TC39 で Async Context が上がっているせい？

https://github.com/tc39/proposal-async-context#proposed-solution

---

# 5/15

## Apollo Server

Resolver 中で発生した状態(= `Context`) に応じて、HTTP Status をゴニョゴニョしたい、というときのやり方について。

https://www.apollographql.com/docs/apollo-server/data/errors/#setting-http-status-code-and-headers に記載されている通り、何通りかのやり方があるが、一番透過的かつレイヤ分離がちゃんとしているのは Plugin 使うパターン。

`willSendResponse` の hook 使うと、Apollo Server としての Status Code に侵襲できる。

```ts
const setHttpPlugin: ApolloServerPlugin<MyContext> = {
  async requestDidStart() {
    return {
      async willSendResponse({ response, contextValue }) {
        // contextValue: AppContext である
        if (contextValue.somethingHappenned()) {
          response.http.status = 500;
        }
      },
    };
  },
};

const server = new ApolloServer({
  typeDefs,
  resolvers,
  plugins: [setHttpPlugin],
});
```
