# 5/1

## PicoML

Table, Element ã® parse éƒ¨åˆ†ã‚’ä½œæˆã™ã‚‹ã€‚Table ãŒå¿…è¦ã«ãªã‚‹ã®ã¯ `funcref` ã¨ `call_indirect` ã§å‹•çš„ãªé–¢æ•°å‘¼ã³å‡ºã—ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã ã‘ã ã‘ãªã®ã§ã€ã“ã‚Œã‚‰ãŒè¡¨ç¾ã§ãã‚Œã°ååˆ†ã¨ã„ã†ã“ã¨ã‚‚ã‚ã£ã¦ã€ä»¥ä¸‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿å¯¾å¿œã€‚

```wat
(table $tbl 1 funcref)
(elem (offset i32.const 0) func $fn)
```

```wat
(table $tbl funcref (elem $fn))
```

WAT é–¢é€£ã®æœ€å¾Œã€Global ã‚‚å¯¾å¿œã€‚

# 5/2

## PicoML

ã‚ˆã†ã‚„ãã€ML -> WASM ã® Compiler éƒ¨åˆ†ã«ç€æ‰‹ã€‚

ã¾ãšã¯ Literal ãªã©ç°¡å˜ãªéƒ¨åˆ†ã‹ã‚‰å®Ÿè£…ã—ã¦ã„ãã€‚ Evaluate ã¨æ§‹é€ ã¯ä¼¼ã¦ã„ã‚‹ã‚ˆã†ã ã‘ã©ã€

- Evaluate: Traverser ãŒå€¤ã‚’è¿”ã™
- Compiler: Traverser ã¯ Module ã® AST ã‚’ä½œã‚Šä¸Šã’ã¦ã„ã

ã¨ãªã‚‹ã®ã§ã€çµæ§‹æ§‹é€ ã¯é•ã„ãã†ã€‚

å¤šåˆ†ã€ä»Šã¾ã¾ã§ã«å®Ÿè£…ã—ãŸã“ã¨ãŒã‚ã‚‹ã‚‚ã®ã§è¿‘ã—ã„ç³»çµ±ã§ã„ã†ã¨ã€ ts-graphql-plugin ã® typegen éƒ¨åˆ†ãŒè¿‘ãã†ã€‚ã‚ã‚Œã‚‚ã€ŒGraphQL Document AST -> TypeScript ASTã€ã¨ã„ã†ç³»çµ±ã ã£ãŸã€‚

åŸºæœ¬çš„ã«ã¯ã€Œä»Šç€ç›®ã™ã¹ãæ§‹é€ (e.g. Selection Set ã«å¯¾å¿œã™ã‚‹ Type å®šç¾©ã® node)ã€ãªã©ã€å¹¾ã¤ã‹ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’ç”¨æ„ã—ã¦ãŠãã€ç‰¹å®šã® node ã« enter ã—ãŸã¨ãã« stack ã‚’ç©ã¿ã€exit ã™ã‚‹éš›ã« stack ã‚’æŠœã‘ã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã‘ã°ã‚ˆã„ã¯ãšã€‚ä»Šå›ã ã¨ã€æã‚‰ã WAT ã®é–¢æ•°å®šç¾©ãƒãƒ¼ãƒ‰ãŒ stack ã¨ã—ã¦å¿…è¦ã«ãªã‚‹ã¯ãšã€‚

ã«ã—ã¦ã‚‚ã€å‹•ä½œç¢ºèªã‚’è€ƒãˆã‚‹ã¨ã€WAT AST -> string ã® unparser ã‚‚æ¬²ã—ããªã£ã¦ã—ã¾ã£ãŸã®ã§ã€ä½œæˆã™ã‚‹ã“ã¨ã«ã€‚ã•ã—ã¦æ‰‹é–“ã‚‚ãªã 500 loc ç¨‹åº¦ã§å®Œæˆã™ã‚‹ã€‚

é©å½“ã«çµ„ã‚“ã å››å‰‡æ¼”ç®—ã¨æ•°å€¤æ¯”è¼ƒã®å¼ãŒ WASM ã« Compile ã§ããŸã—ã€IR ã§ã‚ã‚‹ WAT AST ã‚‚å¯è¦–åŒ–ã§ããŸã®ã§ã€ã ã„ã¶æº€è¶³æ„ŸãŒã§ã¦ããŸã€‚

```ocaml
(* Input *)
2 * 3 + 1 <= 2 + 2
```

```wat
;; Output
(module
   (func $main (result i32)
     i32.const 2
     i32.const 3
     i32.mul
     i32.const 1
     i32.add
     i32.const 2
     i32.const 2
     i32.add
     i32.le_s)
   (export "main" (func $main)))
```

æœ€åˆã«ä¸Šè¨˜ã®ã‚¹ã‚¿ãƒƒã‚¯ãƒã‚·ãƒ³ã«ã¤ã„ã¦è€ƒãˆå§‹ã‚ãŸã®ãŒ [4/10](202104.md#410) ãªã®ã§ã€è¶³æ›ã‘ 20 æ—¥é–“ä»¥ä¸ŠçµŒã£ãŸã‚ã‘ã ã‘ã©ã€ã‚ˆã†ã‚„ãå®Ÿè£…ãŒè¿½ã„ã¤ã„ã¦ããŸã€‚

---

# 5/3

## CoPL

PicoML ã® `let` å¼ã® Compile ã‚’å®Ÿè£…ã™ã‚‹ã«ã‚ãŸã£ã¦ã€ç’°å¢ƒã®å®Ÿè£…æ–¹æ³•ã«å‘ãåˆã†å¿…è¦ãŒã‚ã‚‹ã€‚

ä»Šæ¬²ã—ã„ç‰©ã¯ã€Œå¤‰æ•°å( `string` ) ã«é ¼ã‚‰ãšã«å¤‰æ•°ã‚’ç’°å¢ƒã‹ã‚‰å–ã‚Šå‡ºã›ã‚‹ä»•çµ„ã¿ã€ãªã®ã§ã€CoPL æœ¬ã®ä¸­ã§ã€å”¯ä¸€å®Ÿè£…ã—ã¦ã„ãªã‹ã£ãŸ 6 ç« ã®åç„¡ã—å¼ã«é–¢ã™ã‚‹è¨˜è¿°ã‚’å†åº¦èª­ã‚“ã§ã¿ã‚‹ã€‚

åç„¡ã—å¼å¤‰æ›ã¯ã€De Bruijn Indices ã¨ã„ã†æ–¹æ³•ã‚’ç”¨ã„ã‚‹ã¨ã®ã“ã¨ã€‚

ä»¥ä¸‹ãŒå¤‰æ›ä¾‹ã€‚

```ocaml
fun x ->
  fun y ->
    let z = y + 1 in
    x + y + z
```

```
fun . ->
  fun . ->
    let . = #0 + 1 in
    #2 + #1 + #0
```

`#1` ã§ã‚ã‚Œã°ã€ãã®ã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰è¦‹ã¦ 2 ç•ªç›®ã«å®šç¾©ãŒæ–°ã—ã„ã€ã¨ã„ã†æ„å‘³ã€‚ä¸Šè¨˜ã® `x + y + z` ã¨ã„ã†å¼ã‚’è©•ä¾¡ã™ã‚‹éš›ã®ç’°å¢ƒã¯ä¸‹è¨˜ã®ã‚ˆã†ãªæ§‹é€ ã«ãªã£ã¦ã„ã‚‹ã¯ãšã§ã€å¤‰æ•° `y` ã®å€¤ã‚’å–ã‚Šå‡ºã™ã«ã¯ `env.parent.value` ã¨ã—ã¦
è¦ªã‚’ 1 ã¤ãŸã©ã‚Œã°ã‚ˆã„ã€‚

```js
const env = {
  value: 3,
  parent: {
    value: y,
    parent: {
      value: x,
      parent: root
    }
  }
};
```

ã“ã®ã‚ˆã†ã«ã€Œindex ã®å›æ•°åˆ†ã ã‘è¦ªç’°å¢ƒã‚’è¾¿ã‚‹ã€ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ã§å¤‰æ•°åã‚’ä½¿ã‚ãšã«å€¤ã‚’å–ã‚Šå‡ºã™ã“ã¨ãŒã§ãã‚‹ã€‚

## PicoML

ä¸Šè¿°ã® De Bruijn Indices ãŒåˆ©ç”¨ã§ãã‚‹å‰æã§è€ƒãˆã‚Œã°ã€ä»¥ä¸‹ã® let å¼ã‚’ WAT ã«å¤‰æ›ã§ããã†ã€‚

```ocaml
let a = 10 in
let b = 20 in
a + b
```

```wat
(func $main (result i32)
  i32.const 10

  call $new_env ;; æ–°ã—ã„ç’°å¢ƒã‚’ç”¨æ„ã—ã¦ã€ a ã« 10 ã‚’ã‚»ãƒƒãƒˆã™ã‚‹

  i32.const 20

  call $new_env ;; æ–°ã—ã„ç’°å¢ƒã‚’ç”¨æ„ã—ã¦ã€ b ã« 20 ã‚’ã‚»ãƒƒãƒˆã™ã‚‹

  i32.const 1 ;; ç’°å¢ƒã«ãŠã‘ã‚‹æŸç¸› a ã«ç›¸å½“ã™ã‚‹ index ã‚’å¼•æ•°ã¨ã™ã‚‹
  call $get_val_from_env  ;; a ã®å€¤ã‚’å–ã‚Šå‡ºã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ã«ç©ã‚€

  i32.const 0 ;; ç’°å¢ƒã«ãŠã‘ã‚‹æŸç¸› b ã«ç›¸å½“ã™ã‚‹ index ã‚’å¼•æ•°ã¨ã™ã‚‹
  call $get_val_from_env  ;; b ã®å€¤ã‚’å–ã‚Šå‡ºã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ã«ç©ã‚€

  i32.add

  call $pop_env
  call $pop_env
)
```

ä¸€æ—¦ã€Linked List ã§å®Ÿè£…ã—ã¦ã¿ã‚‹ã‹ã€‚ãŸã ã® Array ã®æ–¹ãŒã‚¢ã‚¯ã‚»ã‚¹åŠ¹ç‡ã¯è‰¯ã•ãã†ãªã‚“ã ã‘ã©ã€é…åˆ—ã«ã™ã‚‹ã¨ã€æ–°ã—ã„ç’°å¢ƒã‚’ä½œã‚‹ãŸã³ã« `memory.copy` ç›¸å½“ã—ãªã„ã¨ã„ã‘ãªã„ã—ã€‚ã€‚ã€‚

ä½•ã¯ã¨ã‚‚ã‚ã‚Œã€ç’°å¢ƒã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã® WASM å´ã®åŸºç›¤éƒ¨å“ã¨ã—ã¦ä¸‹è¨˜ã‚’å®Ÿè£…ã€‚

- Module ã®ä¾å­˜é–¢ä¿‚ç®¡ç†, Module åŒå£«ã‚’çµåˆã™ã‚‹ Builder
- WASM Module
  - Memory Allocator
  - Linker List Environment

Allocator ã«ç€æ‰‹ã—ãŸã¨ã“ã‚ã§ã€local ã® binary unparse ã‚’é–“é•ã£ã¦ã„ãŸã“ã¨ã«æ°—ä»˜ã„ãŸãŸã‚ä¿®æ­£ãŒå¿…è¦ã«ãªã£ãŸã‚Šã¯ã—ãŸãŒã€ä½•ã¨ã‹å®Ÿè£…ã—ãã‚‹ã€‚

ãã‚Œãã‚Œã® WASM Module ã®ãƒ†ã‚¹ãƒˆã‚’ã¡ã‚ƒã‚“ã¨æ›¸ã„ãŸãŠé™°ã‹ã€Compiler éƒ¨åˆ†ã¯ä¸€ç™ºã§ãƒ†ã‚¹ãƒˆé€šã£ãŸã®ã§æˆ‘ãªãŒã‚‰ã¡ã‚‡ã£ã¨æ„Ÿå‹•ã€‚è¨˜å¿µã«ä»¥ä¸‹ã® ML ã‚³ãƒ¼ãƒ‰ã‚’ WAT ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸçµæœã‚’æ®‹ã—ã¦ãŠãã€‚

```ocaml
let a = 10 in
let b = 20 in
a + b
```

```wat
(module
   (memory $__alloc_mem__ 10)
   (global $__alloc_st__ (mut i32)
     i32.const 0)
   (func $__malloc__ (param $size i32) (result i32) (local $next i32)
     global.get $__alloc_st__
     local.set $next
     global.get $__alloc_st__
     local.get $size
     i32.add
     global.set $__alloc_st__
     local.get $next)
   (func $__env_new__ (param $parent_addr i32) (param $value i32) (result i32) (local $addr i32)
     i32.const 8
     call $__malloc__
     local.set $addr
     local.get $addr
     local.get $parent_addr
     i32.store
     local.get $addr
     local.get $value
     i32.store offset= 4
     local.get $addr)
   (func $__env_get__ (param $addr i32) (param $idx i32) (result i32)
     local.get $idx
     i32.const 0
     i32.le_s
     if (result i32)
       local.get $addr
       i32.load offset= 4
     else
       local.get $addr
       i32.load
       local.get $idx
       i32.const 1
       i32.sub
       call $__env_get__
     end)
   (func $__env_parent__ (param $addr i32) (result i32)
     local.get $addr
     i32.load)
   (func $main (result i32) (local $current_env_addr i32)
     i32.const 0
     local.set $current_env_addr
     local.get $current_env_addr
     i32.const 10
     call $__env_new__
     local.set $current_env_addr
     local.get $current_env_addr
     i32.const 20
     call $__env_new__
     local.set $current_env_addr
     local.get $current_env_addr
     i32.const 1
     call $__env_get__
     local.get $current_env_addr
     i32.const 0
     call $__env_get__
     i32.add
     local.get $current_env_addr
     call $__env_parent__
     local.set $current_env_addr
     local.get $current_env_addr
     call $__env_parent__
     local.set $current_env_addr)
   (export "main" (func $main)))
```

æ˜¨æ—¥ã®å››å‰‡æ¼”ç®—ã ã‘ã®ã‚³ãƒ¼ãƒ‰ã«æ¯”ã¹ã¦å¤§åˆ†é•·ããªã£ãŸã€‚å†—é•·ã‚³ãƒ¼ãƒ‰ã¯ä½•ã‹ã—ã‚‰ã®æ‰‹æ®µã§æ’é™¤ã§ããã†ã ã‘ã©ã€

- ML AST ã®æ®µéšã§ç°¡ç´„
- WAT AST ã§æœ€é©åŒ–

ã®ã©ã¡ã‚‰ãŒã„ã„ã®ã ã‚ã†ã€‚ã¾ãä¸€é€šã‚Š Compiler éƒ¨åˆ†ãŒå®Œæˆã—ã¦ã‹ã‚‰è€ƒãˆã‚Œã°ã„ã„ã‹ã€‚

---

# 5/4

## PicoML

ä»Šæ—¥ã¯ if å¼ã® compiler å®Ÿè£…ã‹ã‚‰ã€‚ `then` ã‚‚ã—ãã¯ `else` ã«ç›¸å½“ã™ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠœã‘ã‚‹ã¨ãã® stack ã®å€¤ã‚’ãã®ã¾ã¾ if å¼ã®å€¤ã¨ã—ã¦æ‰±ãˆã°ã‚ˆã„ã ã‘ãªã®ã§ã€æœã¦ã—ãªãç´ ç›´ãªå¤‰æ›ã ã£ãŸã€‚ç§’æ®ºã€‚

å¼•ãç¶šã„ã¦é–¢æ•°å®šç¾©ã¨é–¢æ•°é©ç”¨ã‚’è€ƒãˆã‚‹ã€‚

```ocaml
fun x -> 10
```

ä¸Šè¨˜ã®é–¢æ•°å®šç¾©å¼ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›ã™ã‚Œã°ã‚ˆã„ã¯ãšã€‚

```wat
(module
  ;; (A)
  (func $fn_0 (param $current_env_addr i32) (result i32)
    ;; (B) function body expression
    i32.const 10
  )

  (func $main (result i32)
    ;; (C)
    i32.const 0 ;; element index for $fn_0
  )
  (table $tbl funcref (elem $fn_0)) ;; (D)
)
```

Compile ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

1. æ–°ã—ã„é–¢æ•°å®šç¾©ã‚’é–‹å§‹ã™ã‚‹
2. é–¢æ•°æœ¬ä½“å¼ç”¨ã®ã€De Bruijn Indexer ã‚’ç”¨æ„ã™ã‚‹
3. é–¢æ•°æœ¬ä½“å¼ã‚’æ§‹ç¯‰ã™ã‚‹ (B)
4. é–¢æ•°å®šç¾©ã‚’çµ‚äº†ã—ã€ä½œæˆã—ãŸ (B) ã® WAT Expression ã‚’åŸºã« é–¢æ•°å®šç¾© (A) ã® AST ã‚’ç”¨æ„ã—ã¦ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«çªã£è¾¼ã‚€
5. De Bruijn Indexer ã‚’ã€è¦ªã‚¹ã‚³ãƒ¼ãƒ—ç”¨ã«æˆ»ã™
6. (A) ã®é–¢æ•°ã® Table Element List ä¸Šã® index å€¤ã‚’ã€ã“ã® node ã® instruction ã«ã—ã¦è¿”ã™ (C)

(D) ã® Table å®£è¨€ã«ã¤ã„ã¦ã¯ã€é–¢æ•°å®šç¾©ã®é…åˆ—ãŒã‚ã‚Œã°ä½œæˆå¯èƒ½ãªã®ã§ã€æœ€å¾Œã« module ã‚’æ›¸ãå‡ºã™ã¨ãã« `funcNodes(f => f.id)` ã§ table ã‚’ä½œæˆã™ã‚Œã°ã‚ˆã„ã€‚

æ’ä¾‹ã¨ãªã£ãŸ WAT é­šæ‹“ã¯ä¸‹è¨˜ã€‚

```wat
(module
   (func $__fn_0__ (param $current_env_addr i32) (result i32)
     i32.const 10)
   (func $main (result i32)
     i32.const 0)
   (table $__func_table__ funcref (elem $__fn_0__))
   (export "main" (func $main)))
```

é–¢æ•°é©ç”¨ã¯ã“ã“ã¾ã§ã«ä½œã£ã¦ããŸéƒ¨å“ã®çµ„ã¿åˆã‚ã›ã§å®Ÿç¾ã§ãã‚‹ã¯ãšã€‚

```wat
(func $main (result i32)
  ;; instructions for argument
  ;; stack head should be the argument
  call $__env_new__
  ;; instructions which returns function
  ;; stack head should be the index of the callee function
  call_indirect (type $fn_type)
)
```

ã‚¹ã‚¿ãƒƒã‚¯ã®å…ˆé ­ãŒ [é–¢æ•°ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹, ç’°å¢ƒã®ã‚¢ãƒ‰ãƒ¬ã‚¹å€¤] ã¨ãªã‚‹ã‚ˆã†æº–å‚™ã—ã¦ãŠãã€ `call_indirect` ã‚’å©ã‘ã°æˆ»ã‚Šå€¤ãŒå¾—ã‚‰ã‚Œã‚‹ã€‚

ã“ã®ãƒ—ãƒ©ãƒ³ã§å®Ÿè£…ã—ã¦ã¿ãŸãŒã€ä¸Šæ‰‹ãè¡Œã‹ãªã„ã€‚

`(fun x -> 10)(1)` ã®ã‚ˆã†ãªä¸€éšã®å‘¼å‡ºã¯å•é¡Œãªã‹ã£ãŸãŒã€ä¸‹è¨˜ã®äºŒéšã®é–¢æ•°é©ç”¨ã§å¤±æ•—ã—ã¦ã—ã¾ã£ãŸã€‚

```ocaml
let add = fun a -> fun b -> a + b in add 10 20
```

ä¸Šè¨˜ã®å¼ã«å¯¾ã—ã¦ã€`30` ãŒè¿”å´ã•ã‚Œã‚‹ã¹ãã¨ã“ã‚ã« `21` ãŒè¿”ã£ã¦ãã‚‹ã€‚ ä»¥ä¸‹ã¯å®Ÿéš›ã® WAT å‡ºåŠ›ï¼ˆã® main éƒ¨åˆ†ã®ã¿ï¼‰

```wat
   (func $__fn_0__ (param $current_env_addr i32) (result i32)
     local.get $current_env_addr
     i32.const 1
     call $__env_get__
     local.get $current_env_addr
     i32.const 0
     call $__env_get__
     i32.add)
   (func $__fn_1__ (param $current_env_addr i32) (result i32)
     i32.const 0)
   (func $main (result i32) (local $current_env_addr i32)
     i32.const 0
     local.set $current_env_addr
     local.get $current_env_addr
     i32.const 1
     call $__env_new__
     local.set $current_env_addr
     local.get $current_env_addr
     i32.const 20
     call $__env_new__
     local.get $current_env_addr
     i32.const 10
     call $__env_new__
     local.get $current_env_addr
     i32.const 0
     call $__env_get__
     call_indirect $__func_table__ (type $__fn_type__)
     call_indirect $__func_table__ (type $__fn_type__)
     local.get $current_env_addr
     call $__env_parent__
     local.set $current_env_addr)
```

ãã‚Œãã‚Œã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŒ¯ã£ãŸã‚‚ã®ãŒä¸‹è¨˜ã€‚

```wat
;; fun b -> a + b
(func $__fn_0__ (param $current_env_addr i32) (result i32)
  local.get $current_env_addr
  i32.const 1
  call $__env_get__
  local.get $current_env_addr
  i32.const 0
  call $__env_get__
  i32.add)

;; fun a -> fun b -> a + b
(func $__fn_1__ (param $current_env_addr i32) (result i32)
  i32.const 0)

(func $main (result i32) (local $current_env_addr i32)
  i32.const 0
  local.set $current_env_addr

  ;; let add = ... (function index: 1)
  local.get $current_env_addr
  i32.const 1
  call $__env_new__
  local.set $current_env_addr

  ;; evaluate `add 10 20`

    ;; create new env with 20
    local.get $current_env_addr ;; (X)
    i32.const 20
    call $__env_new__

      local.get $current_env_addr ;; (X)
      i32.const 10
      call $__env_new__

      ;; get funciton index for `add`
      local.get $current_env_addr
      i32.const 0
      call $__env_get__

      call_indirect $__func_table__ (type $__fn_type__)

    call_indirect $__func_table__ (type $__fn_type__)

  ;; finalize `let add = ... in ...`
  local.get $current_env_addr
  call $__env_parent__
  local.set $current_env_addr
)
```

ã“ã“ã¾ã§æ¥ã¦ã‚ˆã†ã‚„ãé–“é•ã£ã¦ã‚‹ç®‡æ‰€ã«æ°—ä»˜ãã€‚

ã‚„ã‚‰ã‹ã—ã¦ã„ã‚‹ã®ã¯ã€ä¸Šè¨˜ã® (X) ã®ã‚³ãƒ¡ãƒ³ãƒˆã®éƒ¨åˆ†ã§ã‚ã‚Šã€Œé–¢æ•°ã«å–°ã‚ã›ã‚‹ç’°å¢ƒã‚’ç¾åœ¨ã®ç’°å¢ƒã‹ã‚‰ä½œæˆã—ã¦ã„ã‚‹ã€ç‚¹ã€‚ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼ã®è©•ä¾¡ç’°å¢ƒã¯ã€ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼å®šç¾©æ™‚ã®ç’°å¢ƒã‹ã‚‰ä½œæˆã—ãªãã¦ã¯ãªã‚‰ãªã„ã®ã«ã€é–¢æ•°å¼ã ã‘ã§è©•ä¾¡ã—ã‚ˆã†ã¨ã—ã¦ã„ãŸã¨ã„ã†å¤§ãƒã‚«ã€‚

é–¢æ•°å®šç¾©ã® Compiler ãŒãã‚‚ãã‚‚èª¤ã£ã¦ã„ãŸã“ã¨ã«ãªã‚‹ã€‚

> 6. (A) ã®é–¢æ•°ã® Table Element List ä¸Šã® index å€¤ã‚’ã€ã“ã® node ã® instruction ã«ã—ã¦è¿”ã™ (C)

ã“ã®å®Ÿè£…ãŒèª¤ã‚Šã§ã€ã€Œindex å€¤ã¨ãã®æ™‚ç‚¹ã§ã®ç’°å¢ƒã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã‚¿ãƒ—ãƒ«ã§ Closure ã‚’è¡¨ç¾ã—ã€ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿”ã™ã€ã¨ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã€‚

```ocaml
let add = fun a -> fun b -> a + b in add 10 20
```

å®Ÿè£…ã—ãªãŠã—ã¦ã€ä¸Šè¨˜ã‚‚æ­£ã—ãè©•ä¾¡ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

é­šæ‹“ã€100 è¡Œè¶…ãˆãŸã®ã§ã€æµçŸ³ã«ä¸€ã€…ã“ã®ãƒ¡ãƒ¢ã«è²¼ã‚‹ã®ã¯ã‚¢ãƒ¬ãªã®ã§ [Gist](https://gist.github.com/Quramy/ca6c2b3b8867257a7d553eb32f655e76) ã«æ®‹ã—ã¦ãŠã„ãŸã€‚

`fun a -> fun b -> a + b` ã¨ã„ã†ä¸­æ–­ã®é–¢æ•°å®šç¾©éƒ¨åˆ†ã ã‘åˆ‡ã‚Šå‡ºã™ã¨ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚

```wat
(func $__fn_0__ (param $current_env_addr i32) (result i32)
  local.get $current_env_addr
  i32.const 1
  call $__env_get__
  local.get $current_env_addr
  i32.const 0
  call $__env_get__
  i32.add)

(func $__fn_1__ (param $current_env_addr i32) (result i32)
  local.get $current_env_addr
  i32.const 0
  call $__tuple_new__)
```

ã“ã‚Œã§ã€ `$__fn_1__` ãŒå‘¼ã°ã‚ŒãŸéš›ã«ã€Œ `a` ã« 10 ã‚’æŸç¸›ã—ãŸç’°å¢ƒ + `$__fn_0__` ã¨ã„ã†é–¢æ•°æœ¬ä½“å¼ã€ã¨ã„ã† Closure ã‚’è¿”å´ã—ã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã€ã“ã® Closure ã‹ã‚‰å–ã‚Šå‡ºã—ãŸç’°å¢ƒã«ã•ã‚‰ã« `b: 20` ã‚’ä»˜ä¸ã—ãŸã‚‚ã®ãŒ `$current_env_addr` ã«æ¸¡ã£ã¦æ­£ã—ãè¨ˆç®—ã§ãã‚‹ã€ã¨ã„ã†æµã‚Œã€‚

è‡ªåˆ†ã¸ã®æˆ’ã‚ã®æ„å‘³ã§ã€å‰åŠã®é–“é•ã£ãŸè¨­è¨ˆéƒ¨åˆ†ã‚‚ãƒ¡ãƒ¢ã«æ®‹ã—ã¦ãŠã“ã†ã€‚

---

# 5/5

## PicoML

å†å¸°é–¢æ•°å®šç¾©ã¨ãã®é©ç”¨è¦å‰‡ã® Compiler ã‚’ä½œã‚‹ã€‚

æœ€åˆã®å®Ÿè£…ã¨ã—ã¦ã¯ã€æ˜¨æ—¥ä½œæˆã—ãŸ Closure ã®è¡¨ç¾ã«ã¤ã„ã¦ã€2 å€¤ã® Tuple ã‹ã‚‰ 3 å€¤ã® Tuple ã«å¤‰æ›´ã—ã€å…ˆé ­ã«ã€Œå†å¸° Closure ã‹ã©ã†ã‹ã€ã®ãƒ•ãƒ©ã‚°ã‚’æŒãŸã›ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ãŸã€‚

ã“ã‚Œã¯ã€JS ç‰ˆã®è©•ä¾¡å™¨ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«é–¢æ•°é©ç”¨æ™‚ã«å†å¸° Closure ã‹ã©ã†ã‹ã‚’è¦‹åˆ†ã‘ã¦ä½œæˆã™ã‚‹ç’°å¢ƒã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ãŸãŸã‚ã€ãŠãªã˜ã‚„ã‚Šæ–¹ã‚’ç„¡æ„è­˜ã«è¸è¥²ã—ã¦ã„ãŸã‹ã‚‰ã€‚

```ts
if (!isClosure(callee)) {
  return error({
    message: `should be function, but ${getEvaluationResultTypeName(callee)}}`,
    occurence: expression.callee
  });
}
if (!isRecClosure(callee)) {
  return next(
    callee.functionDefinition.body,
    createChildEnvironment(
      callee.functionDefinition.param,
      argument,
      callee.env
    )
  );
} else {
  const recEnv = createChildEnvironment(callee.recursievId, callee, callee.env);
  return next(
    callee.functionDefinition.body,
    createChildEnvironment(callee.functionDefinition.param, argument, recEnv)
  );
}
```

ãŸã ã€ã„ã–å®Ÿè£…ã—ã¦ã¿ãŸã¨ã“ã‚ã€é–¢æ•°é©ç”¨æ™‚ã® Instruction ã«æ¯åº¦ `if` ã® block ãŒå…¥ã‚Šè¾¼ã‚“ã§ãã‚‹ã—ã€ä¸€ã€… Closure ã«ã‚‚ Flag ã‚’ç”¨æ„ã—ãªã„ã¨ã„ã‘ãªã„ã—ã§ã€ã‚ã¾ã‚Šã‚·ãƒ³ãƒ—ãƒ«ã¨ã¯è¨€ãˆãªã„å®Ÿè£…ã«ãªã£ã¦ã—ã¾ã£ãŸã€‚

ãã“ã§ä»Šå›ã¯ã€Œå¸¸ã« Closure ã‚’ç’°å¢ƒã«æŸç¸›ã—ã¦ãŠãã€ã¨ã„ã†æ–¹æ³•ã«ã—ã¦ã¿ãŸã€‚JS ç‰ˆã«å³ã—ã¦ã„ã†ã®ã§ã‚ã‚Œã°ã€å¸¸ã«ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§ã„ã†ã¨ã“ã‚ã® `else` ç¯€ã ã‘ã§è©•ä¾¡ã•ã‚Œã‚‹ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚é€šå¸¸ã® `FunctionDefinitionNode` ã®å ´åˆã€`recursievId` ã«ç›¸å½“ã™ã‚‹ De Bruijn Index ãŒæ­¯æŠœã‘ã¨ãªã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ãŠãã€‚

å‡ºåŠ›ã•ã‚Œã‚‹ãƒã‚¤ãƒŠãƒªã®ã‚³ãƒ¼ãƒ‰é‡çš„ã«ã¯ã€ã“ã®ã€Œæ¯åº¦ Closure è‡ªèº«ãŒç’°å¢ƒã«ç„¼ãä»˜ãã€å®Ÿè£…ã®æ–¹ãŒå¾—ãªã‚“ã ã‘ã©ã€Runtime ã®ã‚³ã‚¹ãƒˆã¨ã—ã¦ã¯ã©ã£ã¡ãŒæ­£ã—ã‹ã£ãŸã®ã‹åˆ†ã‹ã‚‰ãªã„ãªã€‚ã€Œé–¢æ•°å†…ã‹ã‚‰è‡ªå·±ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã€ã¯é™çš„ã«ã‚ã‹ã‚‹ã®ã ã‹ã‚‰ã€ã“ã®çµæœã«å¿œã˜ã¦ã€æŸç¸›ã®æœ‰ç„¡ã‚’æ±ºå®šã™ã‚‹ã‚ˆã†ã«ã§ãã‚Œã°ã„ã„ã®ã‹ãªã€‚

ã„ã¤ã‚‚ã®ã‚ˆã†ã«é­šæ‹“ã‚’ã¨ã£ãŸã®ã ã‘ã©ã€è©¦ã—ã« [wabt ã® demo](https://webassembly.github.io/wabt/demo/wat2wasm/) ã«è²¼ã‚Šä»˜ã‘ãŸã¨ã“ã‚ã€Parse Error ã«ãªã£ã¦ã—ã¾ã£ãŸã€‚Memory Argument ã® `offset` ã‚„ `aligin` ã«ã¤ã„ã¦ã€

```wat
i32.store offset= 4
```

ã®ã‚ˆã†ã« ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒˆãƒ¼ã‚¯ãƒ³ã®é–“ã« white space ã‚’å…¥ã‚Œã¦ã„ãŸã®ãŒå•é¡Œã ã£ãŸã€‚ https://webassembly.github.io/spec/core/text/instructions.html#memory-instructions ã«ã‚‚ã€ã“ã‚Œã«é–¢ã™ã‚‹è¨˜è¼‰ã¯ã‚ã£ãŸã‚“ã ã‚ˆã­ã€‚ã€‚ã€‚

> Lexically, an ğš˜ğšğšğšœğšğš or ğšŠğš•ğš’ğšğš— phrase is considered a single keyword token, so no white space is allowed around the â€˜=â€™.

å…ˆæ—¥ã« unparser å®Ÿè£…ã—ãŸéš›ã‚‚å‡ºåŠ›è¦‹ã¦é•å’Œæ„Ÿã‚ã£ãŸã‚“ã ã‘ã©ã€é¢å€’ã ã£ãŸã®ã§æ”¾ç½®ã—ã¦ã„ãŸãƒ„ã‚±ãŒå›ã£ãŸå½¢ã«ã€‚

è«¸ã€…ä¿®æ­£ã—ã¦å®Œæˆã—ãŸé­šæ‹“ã¯[ã“ã¡ã‚‰](https://gist.github.com/Quramy/b6dc71d4d4c15ef575255e09357f7354) ã€‚å¯¾è±¡ã¯å®šç•ªã®éšä¹—è¨ˆç®—ã€‚

```ocaml
let rec fact = fun n -> if n < 1 then 1 else n * fact (n - 1) in
fact 6
```

æ®‹ã™ã¨ã“ã‚ã¯ List ç³»ã€‚ã²ã¨ã¾ãšå˜æ–¹å‘ã® Linked List ç”¨ã® WASM Module ã¨ empty list ã®å¤‰æ›å™¨ã‚’ä½œæˆã—ãŸã€‚

```ocaml
[] == [] (* true *)
```

ã«ã—ãªãã¦ã¯ã„ã‘ãªã„ãŸã‚ã€ã€Œç©ºãƒªã‚¹ãƒˆã¯å¸¸ã«ã‚¢ãƒ‰ãƒ¬ã‚¹å€¤ã¨ã—ã¦ 0 ã‚’è¿”ã™ã€ã¨ã„ã†é¢¨ã«ã—ã¦é€ƒã’ãŸã€‚

---

# 5/6

## PicoML

Cons List Operation ã® Compiler ã‚’ä½œæˆã€‚Instruction éƒ¨åˆ†ã«ã¯å•é¡ŒãŒç„¡ã‹ã£ãŸãŒã€ç‰¹å®šã®æ¡ä»¶ã§ã‚ˆã‚ã—ããªã„æŒ™å‹•ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã«æ°—ä»˜ãã€‚

æ˜¨æ—¥ã®

> ã€Œç©ºãƒªã‚¹ãƒˆã¯å¸¸ã«ã‚¢ãƒ‰ãƒ¬ã‚¹å€¤ã¨ã—ã¦ 0 ã‚’è¿”ã™ã€ã¨ã„ã†é¢¨ã«ã—ã¦é€ƒã’ãŸã€‚

ã«é–¢ä¿‚ã™ã‚‹ãŒã€ç·šå½¢ãƒ¡ãƒ¢ãƒªã‹ã‚‰æœ€åˆã«æ‰•ã„å‡ºã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚ 0 ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€`1::[]` ã ã‘ã®å¼ã«ãŠã„ã¦ã€ã“ã®ãƒªã‚¹ãƒˆã®ãƒã‚¤ãƒ³ã‚¿å€¤ãŒ 0 ã«ãªã£ã¦ç©ºãƒªã‚¹ãƒˆæ‰±ã„ã•ã‚Œã¦ã—ã¾ã£ã¦ã„ãŸã€‚Allocator å´ã§ã€Œã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã—ã¦åˆ©ç”¨ã™ã‚‹å€¤ã¯ 4 ä»¥ä¸Šã€ã¨ã—ã¦ä¿®æ­£ã€‚

ã“ã‚Œã§æ®‹ã™ã¨ã“ã‚ã¯ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã®ã¿ã«ãªã£ãŸã€‚ãŠã•ã‚‰ã„ã®ãŸã‚ã«ã€JS ç‰ˆã®è©•ä¾¡å™¨ã§ã® Matcher å®Ÿè£…ã‚’çœºã‚ã¦ã¿ã‚‹ã€‚

```ts
interface Substitution {
  readonly lhs: IdentifierNode;
  readonly rhs: EvaluationValue;
}

function isMatchInner(
  value: EvaluationValue,
  pattern: MatchPatternNode,
  substitutions: readonly Substitution[]
): readonly Substitution[] | null {
  if (pattern.kind === "WildcardPattern") {
    return substitutions;
  } else if (pattern.kind === "EmptyListPattern") {
    return isList(value) && value.length === 0 ? substitutions : null;
  } else if (pattern.kind === "IdPattern") {
    return [...substitutions, { lhs: pattern.identifier, rhs: value }];
  } else if (pattern.kind === "ListConsPattern") {
    if (!isList(value)) return null;
    if (value.length === 0) return null;
    const [head, ...tail] = value;
    const resultHead = isMatchInner(head, pattern.head, substitutions);
    const resultTail = isMatchInner(tail, pattern.tail, substitutions);
    if (!resultHead || !resultTail) return null;
    return [...substitutions, ...resultHead, ...resultTail];
  }
  // @ts-expect-error
  throw new Error(`invalid kind: ${pattern.kind}`);
}

export function isMatch(
  value: EvaluationValue,
  pattern: MatchPatternNode,
  env: Environment
): Environment | null {
  const substitutions = isMatchInner(value, pattern, []);
  if (!substitutions) return null;
  return substitutions.reduce(
    (env, { lhs, rhs }) => createChildEnvironment(lhs, rhs, env),
    env
  );
}
```

JS ç‰ˆã®è©•ä¾¡å™¨ã¯ Interpreter ã§ã‚ã£ãŸãŸã‚ã€å®Ÿè¡Œæ™‚ã«å€¤ã¨ AST ã§ã‚ã‚‹ `MatchPatternNode` ã®åŒæ–¹ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã‚ã£ãŸã®ã§ã€ä¸Šè¨˜ã®ã‚ˆã†ã« `isMatch` é–¢æ•°ã‚’ Generic ã«ç”¨æ„ã§ãã¦ã„ãŸã€‚

ä¸€æ–¹ã€ Compiler ã®å ´åˆã€å®Ÿè¡Œæ™‚ã«ã¯ AST æƒ…å ±ã¯å‚ç…§ã§ããªã„ã®ã§ã€Compile æ™‚ã« Adaptive ã« `pattern` ã«å¿œã˜ãŸ Matcher é–¢æ•°ã«å±•é–‹ã™ã‚‹ã‚ˆã†ã«ã—ãŸã€‚

```ocaml
match 0 with x::y::[] -> x | _ -> 0
```

ä¾‹ãˆã°ä¸Šè¨˜ã®ã‚ˆã†ãª match å¼ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚ã€Œmatch ã—ãŸã‚‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å®šç¾©ã•ã‚ŒãŸå¤‰æ•°ã‚’ç¾åœ¨ã®ç’°å¢ƒã«è¿½åŠ æŸç¸›ã—ãŸæ–°ã—ã„ç’°å¢ƒã‚’è¿”ã™ã€ã¨ã„ã†åŸºæœ¬çš„ãªè€ƒãˆæ–¹ã¯ Interpreter ã¨ä¸€ç·’ã€‚

```wat
(func $__matcher_0__ (param $current_env_addr i32) (param $value i32) (result i32)
  local.get $current_env_addr
  local.get $value
  call $__matcher_is_matched_wildcard_pattern__)

(func $__matcher_1__ (param $current_env_addr i32) (param $value i32) (result i32)
  local.get $value
  if (result i32)
    local.get $value
    local.get $value
    call $__list_head__
    local.set $value
    local.get $current_env_addr
    local.get $value
    call $__matcher_is_matched_identifier_pattern__
    local.set $current_env_addr
    call $__list_tail__
    local.set $value
    local.get $value
    if (result i32)
      local.get $value
      local.get $value
      call $__list_head__
      local.set $value
      local.get $current_env_addr
      local.get $value
      call $__matcher_is_matched_identifier_pattern__
      local.set $current_env_addr
      call $__list_tail__
      local.set $value
      local.get $current_env_addr
      local.get $value
      call $__matcher_is_matched_empty_list_pattern__
    else
      i32.const 0
    end
  else
    i32.const 0
  end)

(func $main (result i32) (local $current_env_addr i32) (local $value_for_matcher i32) (local $matched_env_addr i32) (local $prev_env_addr i32)
  i32.const -1
  local.set $current_env_addr
  i32.const 0
  local.set $value_for_matcher
  local.get $current_env_addr
  local.get $value_for_matcher

  call $__matcher_1__
  local.tee $matched_env_addr
  if (result i32)
    local.get $current_env_addr
    local.set $prev_env_addr
    local.get $matched_env_addr
    local.set $current_env_addr
    local.get $current_env_addr
    i32.const 1
    call $__env_get__
    local.get $prev_env_addr
    local.set $current_env_addr
  else
    local.get $current_env_addr
    local.get $value_for_matcher
    call $__matcher_0__
    local.tee $matched_env_addr
    if (result i32)
      local.get $current_env_addr
      local.set $prev_env_addr
      local.get $matched_env_addr
      local.set $current_env_addr
      i32.const 0
      local.get $prev_env_addr
      local.set $current_env_addr
    else
      unreachable
    end
  end)
```

if block ã®æœ«å°¾ã®æ–¹ã«ã‚ã‚‹ä¸‹è¨˜ã® Instruction ã¯ã€ã“ã® match å¼ã®è©•ä¾¡ãŒçµ‚ã‚ã£ãŸå¾Œã«ã€é–¢æ•°å†…ã§åˆ¥ã®è©•ä¾¡ãŒèµ°ã£ãŸå ´åˆã«ç’°å¢ƒæƒ…å ±ã‚’æˆ»ã™ãŸã‚ã®ã‚‚ã®ã€‚ã“ã‚ŒãŒç„¡ã„ã¨ã€

```wat
    local.set $current_env_addr
    local.get $current_env_addr
```

```ocaml
let a = 20 in
(match 100 with x -> x) + a
```

ã®è©•ä¾¡çµæœãŒ 200 ã«ãªã£ã¦ã—ã¾ã†ã€‚

åŒä¸€ã‚¹ã‚¿ãƒƒã‚¯å†…ã®ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®æˆ»ã—å¿˜ã‚Œã«èµ·å› ã™ã‚‹ãƒŸã‚¹ã«ã¤ã„ã¦ã¯æ—¢ã«ã‚„ã‚‰ã‹ã—ã¦ã„ã¦ã€é–¢æ•°é©ç”¨æ™‚ã«ä¸‹è¨˜ã®ã‚ˆã†ã«ã€Œä»Šã‹ã‚‰åˆ©ç”¨ã™ã‚‹ Closure ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã‚’ä¿æŒã—ã¦ã„ã‚‹ã®ã ã‘ã©ã€ã“ã‚Œã‚’é–¢æ•°é©ç”¨çµ‚äº†æ™‚ã«æˆ»ã—å¿˜ã‚Œã¦ã„ãŸã€‚

```wat
call $__env_get__
local.tee $closure_addr
```

ã“ã®ã›ã„ã§ã€ä»¥ä¸‹ã®å¼ã‚’ãƒ†ã‚¹ãƒˆã—ãŸéš›ã«ç„¡åŠ¹ãª table ã‚¢ã‚¯ã‚»ã‚¹ãŒç™ºç”Ÿã—ã¦ã—ã¾ã£ãŸã€‚

```ocaml
let rec fact = fun n -> if n < 2 then 1 else n * fact(n - 1) in
let rec range = fun s -> fun e -> if s >= e then [] else s::(range (s + 1) e) in
let rec map = fun f -> fun list -> match list with [] -> [] | x::y -> (f x)::(map f y) in
map fact (range 1 7) (* [1; 2; 6; 24; 120; 720] *)
```

æœ€åˆã©ã“ã§ã¶ã£å£Šã‚ŒãŸã®ã‹ãŒå…¨ç„¶ã‚ã‹ã‚‰ãªã‹ã£ãŸã‘ã©ã€ãŸã¾ãŸã¾ match å¼ã®ã¨ãã®å¤‰æ•°æˆ»ã—ã®å¯¾å¿œãŒæ€ã„æµ®ã‹ã‚“ã ã®ã§ã€ãƒŸã‚¹ã«å½“ãŸã‚ŠãŒä»˜ã„ãŸã‹ã‚‰è‰¯ã‹ã£ãŸã‘ã©ã€WASM ã® Runtime Error ãŒèµ·ã“ã‚‹ã¨æ‰‹ã‚‚è¶³ã‚‚å‡ºãªããªã‚‹ã®ã¯çµæ§‹ã¾ãšã„ãªã€‚ã€‚ã€‚

ä¿®æ­£ & WASM Compiler Branch ã‚’ãƒãƒ¼ã‚¸ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã®ä¸Šè¨˜ã®å¼ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœã¯ [ã“ã¡ã‚‰](https://gist.github.com/Quramy/fbfbb8738aa36482727e1dd6e7e1d8e4) ã€‚

ãªã‚“ã¨ã‹å‹•ãã¨ã“ã¾ã§æ¼•ãç€ã‘ã‚‹ã“ã¨ãŒã§ãã¦æ„Ÿç„¡é‡ã ã€‚

## Misc

ãµã¨ã€Œã©ã“ã‹ã§ WASM ã«é–¢ã™ã‚‹å‹‰å¼·ä¼šã‚„ã£ã¦ãªã„ã‹ãªï¼Ÿã€ã¨æ€ã£ã¦ Connpass èª¿ã¹ã¦ã¿ãŸã¨ã“ã‚ã€ Web24 ã¨ã„ã†ä¼šãŒ 5/7 ã«é–‹å‚¬ã•ã‚Œã‚‹ã®ã‚’è¦‹ã¤ã‘ãŸã€‚ WASM ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚‚ã‚ã‚‹ã‚ˆã†ã§ã€ @bokuweb ã•ã‚“ã‚‚ç™»å£‡ã™ã‚‹ã¿ãŸã„ã€‚

---

## Web24

ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãªã—ã€è³‡æ–™ãªã—ã€å°æœ¬ãªã—ã¨ã®ã“ã¨ã€‚åŒåƒšã®åˆ†ã«ã¤ã„ã¦ã¯å¾Œã‹ã‚‰è©±èã‘ã°ã„ã„æ°—ãŒã—ã¦ããŸã®ã§ã€wasm ã®ã¨ã“ã ã‘è¦³ã‚‹ã“ã¨ã«ã—ã‚ˆã£ã¨ã€‚

## PicoML

å¤§ç‰ã® Compiler ãŒçµ‚ã‚ã£ãŸã®ã§ã€è½ç©‚ã²ã‚ã„ç³»ã‚’ã„ãã¤ã‹ã‚„ã£ã¦ãŠããŸã„ã€‚æ°—ã«ãªã£ã¦ã‚‹ç®‡æ‰€ã¯ä¸‹è¨˜ã‚ãŸã‚Šã€‚

- ã‚³ãƒ¡ãƒ³ãƒˆã‚’ Parse ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- WASM unparser ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
- Compiler ã® Context å‘¨ã‚Šã‚’ã‚‚ã†å°‘ã—ç¶ºéº—ã«ã™ã‚‹
- `NumberLiteral` ã‚’ `IntLiteral` ã« rename ã—ãŸã„
- CLI ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼

ä»Šæ—¥ã¯ä¸‹è¨˜ã‚’å®Ÿè£…ã€‚

> - ã‚³ãƒ¡ãƒ³ãƒˆã‚’ Parse ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
> - `NumberLiteral` ã‚’ `IntLiteral` ã« rename ã—ãŸã„

## Vim

æ»…å¤šã«ä½¿ã‚ãªã„ã®ã§åå‰ã™ã‚‰å¿˜ã‚Œã¦ã—ã¾ã†ã€ãƒã‚¤ãƒŠãƒªã‚’ã„ã„æ„Ÿã˜ã«ç¢ºèªã™ã‚‹ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚ã‚‹ `xxd` ã€‚ã“ã‚Œã£ã¦ Vim ã«ä»˜å±ã—ã¦ã„ã‚‹ CLI ã ã£ãŸã®ã­ã€‚Linux ã®å ´åˆã ã¨ã€æ¨™æº–çš„ã«ã¯ `od` ã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚‹ã‚ˆã†ã ã‘ã©ã€è‰²ã€…ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ãªã„ã¨è¦‹ã«ãã„ã®ã§ã€ã‚„ã¯ã‚Š `xxd` ã®æ–¹ãŒå„ªç§€ã§ã¯ã‚ã‚‹ã€‚

Vim ã‹ã‚‰ä½¿ã†ã¨ãã¯ã€

- é©å½“ãªãƒã‚¤ãƒŠãƒªã‚’ Vim ã§é–‹ã
- `:%!xxd` ã‚’å®Ÿè¡Œã™ã‚‹

ã¨ã™ã‚Œã°ã‚ˆã„ã€‚

---

# 5/9

## PicoML

Web Playground ã«å–ã‚Šæ›ã‹ã‚‹ã€‚

æœ€åˆã€Codemirror ã‚’ä½¿ã†ã‚‚ã€ã©ã†ã‚‚ Error Highlight ã®å‘¨ã‚ŠãŒé¢å€’ãã†ã ã£ãŸãŸã‚ã€ä»¥å‰ã«ä½¿ã£ãŸã“ã¨ã®ã‚ã‚‹ Ace Editor ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã«ã—ãŸã€‚

https://github.com/Quramy/ts-server-side-anatomy/blob/master/ls-web-local/src/editor/index.ts

Ace ã‚„ PrismJS ã® yak shaving ã«ãªã£ã¦ããŸãªã€‚

---

# 5/10

## PicoML

Web Playground ã®ã¤ã¥ãã‚’ã‚„ã‚‹ã€‚

Ace Editor / PrismJS / react-json-view ã® theme ã‚’ã™ã¹ã¦ Custom Theme ã«ã—ã¦ Iceberg é¢¨ã«æƒãˆãŸã€‚https://github.com/cocopon/iceberg.vim/blob/master/colors/iceberg.vim ã«è¨˜è¼‰ã•ã‚Œã¦ã„ãŸ Hex Code ã‚’å‚è€ƒã«ã—ãŸã€‚

## Color Theme

react-json-view ã® Custom Theme ã‚’è¨­å®šã™ã‚‹éç¨‹ã§çŸ¥ã‚‹ã€‚

ã‚¨ãƒ‡ã‚£ã‚¿ã‚„ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã® Color Scheme ã‚’æ±ºå®šã™ã‚‹ä¸Šã§ã€16 è‰²ã«å½“ã¦ã¯ã‚ã¦è€ƒãˆã‚ˆã†ã€ã¨ã„ã†ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã€‚

https://github.com/chriskempson/base16

> - **base00** - Default Background
> - **base01** - Lighter Background (Used for status bars, line number and folding marks)
> - **base02** - Selection Background
> - **base03** - Comments, Invisibles, Line Highlighting
> - **base04** - Dark Foreground (Used for status bars)
> - **base05** - Default Foreground, Caret, Delimiters, Operators
> - **base06** - Light Foreground (Not often used)
> - **base07** - Light Background (Not often used)
> - **base08** - Variables, XML Tags, Markup Link Text, Markup Lists, Diff Deleted
> - **base09** - Integers, Boolean, Constants, XML Attributes, Markup Link Url
> - **base0A** - Classes, Markup Bold, Search Text Background
> - **base0B** - Strings, Inherited Class, Markup Code, Diff Inserted
> - **base0C** - Support, Regular Expressions, Escape Characters, Markup Quotes
> - **base0D** - Functions, Methods, Attribute IDs, Headings
> - **base0E** - Keywords, Storage, Selector, Markup Italic, Diff Changed
> - **base0F** - Deprecated, Opening/Closing Embedded Language Tags, e.g. `<?php ?>`

---

# 5/11

## èªè¨¼èªå¯

Firebase Auth ã® Custom Token ã®ä»•çµ„ã¿ã®è“‹ã‚’é–‹ã‘ã«è¡Œãã€‚ OAuth 2.0 ã¾ãŸã¯ OIDC ã® Authorization Code flow ã ã£ãŸã¨ã—ã¦ã€ã‚¢ãƒ—ãƒªã‹ã‚‰ã®èªè¨¼çµ‚äº†ã¾ã§ã®æµã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

https://firebase.google.com/docs/auth/web/custom-auth?hl=ja

1. App -> Client Server: Authorization request
2. Client Server -> App : Redirect to Authorization Srever Endpoint
3. App <--> Authorization Server: End-user Authorization
4. Authorization Server -> App: Redirect to Client Server with authorization code
5. App -> Client Server: request with authorization code
6. Client Server -> Authorization Server: Token Request using code and client secret
7. Authorization Server -> Client Server: Access Token or ID Token
8. Client Server -> Authorization Server: Request User profile using token
9. Authorization Server -> Client Server: User Profile
10. Client Server -> Firebase: Request Custom Token using User Profile with Service Account
11. Firebase -> Client Server: Custom ID Token for Firebase Auth
12. Client Server -> App: Custom ID Token
13. App -> Firebase: Login or Create Account as Firebase user using Custom ID Token

2 ~ 7 ãŒ OAuth 2.0 / OIDC ã®ãƒ•ãƒ­ãƒ¼éƒ¨åˆ†ã€10 ~ 12 ãŒ Firebase Admin åˆ©ç”¨éƒ¨åˆ†ã€13 ãŒã‚¢ãƒ—ãƒªå´ã§ã® Firebase Auth åˆ©ç”¨ç®‡æ‰€ã¨ãªã‚‹ã€‚

## PicoML

ä»Šæ—¥ã‚‚ Web Playground ã®ã¤ã¥ãã€‚wasm ã§ evaluate ã—ãŸçµæœã‚’è¡¨ç¤ºã™ã‚‹éƒ¨åˆ†ã€jsv ã ã¨å¾®å¦™ãªæ„Ÿã˜ã ã—ã€è‡ªåˆ†ã§ Component ä½œã‚‹ã‹ã€‚

å¤§æ ã®æ©Ÿèƒ½ã¯å‡ºæƒã£ã¦ããŸã®ã§ã€ä¸€æ—¦ main ã« merge ã—ãŸã€‚

- å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã« title å…¥ã‚Œã‚‹
- logger ã« run / clear log action ã‚’ä»•è¾¼ã‚€
- ã‚³ãƒ¼ãƒ‰ã‚’ URL fragment ã§ä¿æŒ
- Header / Footer ã‚’ã¡ã‚ƒã‚“ã¨ã„ã‚Œã‚‹

## GitHub Actions

GH Pages ã« deploy ã™ã‚‹ã¨ãã« `peaceiris/actions-gh-pages` ãŒä¾¿åˆ©ã€‚ `GITHUB_TOKEN` ã¯ Action ã«å®šç¾©æ¸ˆã¿ã®ç’°å¢ƒå¤‰æ•°ãªã®ã§ã€ç‰¹ã« Private Token ã®æ‰•ã„å‡ºã—ã‚’ã—ãªãã¦ã‚‚ä½¿ãˆã‚‹ã®ã‚‚ã‚ˆã„ã€‚

```yaml
- name: Publish gh-pages
  uses: peaceiris/actions-gh-pages@v3
  with:
    github_token: ${{ secrets.GITHUB_TOKEN }}
    publish_dir: ./playground/dist
```

ä»Šã¾ã§ã¯ã€npm ã® gh-pages ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å…¥ã‚Œã¦ãŠã„ã¦ã€CI ã« deploy key ã‚’ä»•è¾¼ã‚“ã ã‚Šã—ã¦ã‚„ã£ã¦ã„ãŸãƒ•ãƒ­ãƒ¼ãŒç°¡å˜ã«ãªã£ãŸã€‚
