# 1/4

## reg

少し前に思いついた「wiki に画像と json 保持させてホスティングした report UI で表示する」の PoC を始める。

たまたま @bokuweb が https://github.com/bokuweb/reg-actions をやり始めていたのもきっかけ。

GitHub Raw Content から JSON を fetch するプラン自体は問題なくできそうであるが、当然 CORS になるため、Canvas から 2D Context の取得ができなくなり、x-img-diff の marker 表示が block されることに気づく。

https://github.com/Quramy/reg-gh-action-poc/pull/://github.com/Quramy/reg-gh-action-poc/pull/1

結論からすると、結構微妙かもしれない。

`https://raw.githubusercontent.com/wiki/Quramy/reg-gh-action-poc/reg-assets/8402aef54d0bebaec4cd2060e93d1650be2b2cd5/reg.json` の URL であれば、確かに CORS で fetch できるが、private repo だと絶対に使えない。

Private Repo の場合、ここに `?token=XXXXXX` が付与されることになる。 `https://github.com/Quramy/reg-gh-action-poc/wiki/reg-assets/8402aef54d0bebaec4cd2060e93d1650be2b2cd5/reg.json` とすればトークン付きの URL に redirect されるが、こっちの URL は CORS に引っかかることになる。

なので、真面目に対応しようとすると、Report UI を OAuth App なり GitHub App なりにして、ユーザーから正しく token 貰った上で GitHub API で Download URL をもらうくらいしか思いつかない。

https://docs.github.com/en/rest/reference/repos#get-repository-content

# 1/5

## jest

やたら jest で OOM が出たので、heap 増やしつつ usage を確認するコマンドを :memo:

```sh
node --max_old_space_size=4096 --expose-gc ./node_modules/.bin/jest --runInBand --logHeapUsage
```

https://qiita.com/takayukioda/items/1b17f831562971a8a700

## ESLint

いつもわからなくなる「ディレクトリ間の import を制限する」というやつ。

https://github.com/import-js/eslint-plugin-import/blob/main/docs/rules/no-restricted-paths.md

`target` と `from` がどちらがどちらなのか、わからなくなりやすいが「`from` -> `target` の方向の import のみ許可する」と考えると理解しやすい。

例えば Next.js x Atomic Design な Project の場合、以下のようになる。

```js
module.exports = {
  rules: {
    "import/no-restricted-paths": [
      "error",
      {
        zones: [
          {
            // Page components MUST be composite of Templates
            target: "src/components/templates/**/*",
            from: "src/pages/**/*"
          },
          {
            // Template components MUST be composite of Organisms
            target: "src/components/organisms/**/*",
            from: "src/templates/**/*"
          },
          {
            // Organism components MUST be composite of Molecules
            target: "src/components/molecules/**/*",
            from: "src/components/{templates,organisms}/**/*"
          },
          {
            // Molecule components MUST be composite of Atoms
            target: "src/components/atoms/**/*",
            from: "src/components/{templates,molecules,organisms}/**/*"
          }
        ]
      }
    ]
  }
};
```

## TypeScript

先月に書いた

> 前々から少し考えてはいたんだけど、talt と ts-query で簡単なコード編集系の tool を作れないだろうか。

の件をなんとなく作り始める。

https://github.com/Quramy/tourner

これに付随して、tsquery をまたいじりだしのだけど Web Playground があることを知った。めっちゃ Angular Material 製だ。

https://tsquery-playground.firebaseapp.com/

## Misc

faker.js が死んでいたことに対する経緯など https://note.com/takahiroyte/n/nd6cceae3af04

---

# 1/6

## Tourner

Query と Update の骨子部分はなんとなくできてきた。

```ts
test("query and replace", () => {
  const result = SourceFileDocument.createFromSourceFile(
    getSourceFile(`const a = 1; const b = 'x' + 'y'; /* foo! */ const c = 3;`)
  )
    .query<ts.VariableStatement>("VariableStatement:has(Identifier[name='b'])")
    .replace(({ query }) =>
      template.statement`export const b = INITIALIZER;`({
        INITIALIZER: query("*.initializer").first.node
      })
    )
    .end()
    .commit().text;

  expect(result).toContain("export const b = 'x' + 'y'");
});
```

## Node.js

minimatch は最近利用されないらしいので、別のオプションしらべてたところ、コイツが一番軽量っぽい。

https://www.npmjs.com/package/picomatch

確か Storybook とかも使っていたような...?

micromatch や nanomatch もあるので紛らわしいのよね。

## Vim

`<bar>` で複数コマンドが実行できることを今更知る。

やりたかったことは、`:terminal` を縦分割で開く、というやつなんだけど、`:terminal` のオプションそのものにはないので、`:vsplit` と連続実行する `nnoremap` を書きたくなったため。

```vim
:vsp | term ++curwin
```
