# 12/1

## Prisma

jest-prisma で Client Extension feature を試そうと思ったが、厳しい。

https://github.com/prisma/prisma/issues/16582

---

# 12/5

## Prisma

jest-prisma と prisma-fabbrica の件をまとめてアドベントカレンダーの記事として公開。

https://quramy.medium.com/integrated-testing-with-prisma-4bc73404d027

エモさは控えめになってしまった感もある。

もうひとつのコンテキストとして「 RSpec と Jest でのコンテキストスイッチを極力下げたい」という話には一切踏み込まずに書いたのだけど、それを主眼にした別の記事もあったほうがいいのかなぁ。

---

# 12/6

## prisma-fabbrica

ESM 対応、といっても Named Exports な CJS を Exports Map でくるんだだけだけど、を完了させた。
Publish 時に package.json の `files` を足し忘れるポカをやらかす。

Distribution file の構成変えた後に、 `npm publish --dry-run` し忘れるの、これで何回目だろ。。。

ESM の動作確認的な意味合いで、prisma-yoga-example を `--module node16` 対応した。ただ、バックエンドのアプリケーションを ESM 化するの、ホントモチベーションが上がらない。ツールの設定が面倒なだけで旨味がまるで無い。

---

# 12/8

## jest-prisma

`beforeAll` など、トランザクションが確立されていない状態で `jestPrimsa.client.xxxx` されると落ちてしまう件について、warn メッセージを出力するように修正。

---

# 12/12

## jest-prisma

割と面倒な issue が報告されて頭を悩ますことになった。

https://github.com/Quramy/jest-prisma/issues/56

Reproducing code snippet をそのまま貼ると以下ようなパターン。

```ts
/**
 *
 * @jest-environment-options { "verboseQuery": true }
 *
 */
import { PrismaClient } from "@prisma/client";

describe("Should include date type work around", () => {
  /* NG */
  const prisma = jestPrisma.client;
  /* NG */
  //  const prisma = jestPrisma.originalClient;
  /* OK */
  // const prisma = new PrismaClient();

  beforeEach(async () => {
    await prisma.post.create({
      data: {
        id: "post0",
        title: "post",
        author: {
          create: {
            id: "user0",
            name: "quramy"
          }
        }
      }
    });
  });

  test("include api should work using date type condition", async () => {
    const user = await prisma.user.findFirst({
      where: {
        createdAt: {
          lt: new Date(),
          gte: new Date(new Date().getTime() - 1000 * 60 * 60 * 24)
        }
      },
      include: {
        posts: {
          where: {
            createdAt: {
              lt: new Date(),
              gte: new Date(new Date().getTime() - 1000 * 60 * 60 * 24)
            }
          }
        }
      }
    });

    expect(
      (await prisma.post.findFirst({
        where: {
          author: {
            createdAt: {
              lt: new Date(),
              gte: new Date(new Date().getTime() - 1000 * 60 * 60 * 24)
            }
          }
        },
        include: {
          author: {
            include: {
              posts: {
                where: {
                  createdAt: {
                    lt: new Date(),
                    gte: new Date(new Date().getTime() - 1000 * 60 * 60 * 24)
                  }
                }
              }
            }
          }
        }
      }))!.author
    ).toStrictEqual(user);
  });
});
```

特に問題となるのが、以下の `include` に DateTime を受ける where 条件が指定されているときで、これが Jest の環境下だと Prisma の Runtime Validation に引っかかってしまう。

```js
const include = {
  posts: {
    where: {
      createdAt: {
        lt: new Date(),
        gte: new Date(new Date().getTime() - 1000 * 60 * 60 * 24)
      }
    }
  }
};
```

例のごとく https://github.com/facebook/jest/issues/2549 のせいなのは最早ひと目見て分かるようになってしまったが、Jest の標準機能と競合せずにこの問題を回避する術が全く思い浮かばない。

- `this.global.Date = Date` のような逆パッチを当てつつ、opt-out できるようにオプションを用意する

などが考えられなくはないが「ユーザーの責任において適用しろ」という以上、https://www.npmjs.com/package/jest-environment-node-single-context のような Single context な Environment に jest-prisma を織り込むのと大差無い気がする。

---

# 12/13

## GraphQL

https://github.com/gabotechs/graphqx://github.com/gabotechs/graphqxl
