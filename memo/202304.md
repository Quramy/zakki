# 4/5

## typescript-eslint-language-service

少し前から謎だった、 ESLint を最新化すると、 `eslint:recommended` を継承した config のときに落ちてしまう件について、 https://github.com/Quramy/typescript-eslint-language-service/issues/523 で原因を教えてもらった。

https://github.com/eslint/eslint/pull/16844 にて、 Config js の位置が移動したのが原因。

これを切欠に知ったのだが、Experimental な扱いではあるが、eslintrc の書き方が大きく変更されるみたい。

https://eslint.org/docs/latest/use/configure/configuration-files-new#using-predefined-configurations

```js
import js from "@eslint/js";

export default [
  {
    files: ["**/src/safe/*.js"],
    ...js.configs.recommended,
  },
];
```

mjs で書くのはまぁさして驚きはないとして、config array そのものを返すような形になっていた。

もう全員がこの形式で書いてくれれば、language service としても、楽になりそうな気はするんだよなぁ。

## Storycap

Storybook v7 の E2E 追加してもらえた。助かる。

---

# 4/6

## graphql-ruby

GraphQL における Query Rejection について考えてみた。

大きく分けて 2 系統あって、

- A. Ahead of time rejection: 静的解析
- B. Runtime rejection: 実行時処理

graphql-ruby であれば、 A. は https://graphql-ruby.org/queries/ast_analysis.html#errors であり、

```ruby
class NoFieldsCalledHello < GraphQL::Analysis::AST::Analyzer
  def on_leave_field(node, _parent, visitor)
    if node.name == "hello"
      @field_called_hello = true
    end
  end

  def result
    GraphQL::AnalysisError.new("A field called `hello` was found.") if @field_called_hello
  end
end
```

B. は https://graphql-ruby.org/authorization/authorization.html#field-authorization である。

```ruby
class Types::BaseField < GraphQL::Schema::Field
  # Pass `field ..., require_admin: true` to reject non-admin users from a given field
  def initialize(*args, require_admin: false, **kwargs, &block)
    @require_admin = require_admin
    super(*args, **kwargs, &block)
  end

  def authorized?(obj, args, ctx)
    # if `require_admin:` was given, then require the current user to be an admin
    super && (@require_admin ? ctx[:viewer]&.admin? : true)
  end
end
```

どちらも Custom Directive と連携させるようなことはさして難しくないため、以下のような Schema を実装できる。

```gql
directive @allowIfHoge on FIELD_DEFINITION

type Query {
  fuga: String! @allowIfHoge
}
```

あとは向き不向きの話だ。

- パターン A: そもそも Execution すらして欲しくないケースに向く
  - e.g. Operation Complexity の制限
- パターン B: Parent Object の状況にポリシーが大きく依存するものに向く
  - e.g. 組織一覧を取得した場合に、自分の所属組織かどうかによって、field のアクセスレベルが変わる

いずれにせよ、Schema で規定されていること以上の内容はできないので、Reject した場合の挙動として選択できるのは `GraphQLError` の raise 程度。Reject された理由であったりを アプリケーションレイヤできちんと表示するような要件なのであれば、それを `GraphQLError` として扱うことについて下策と考えるスタンスに変化がない。
