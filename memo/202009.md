# 9/28

## GraphQL

Gatsby と ts-graphql-plugin 組み合わせられない？

Gatsby の graphql fragment 解決方法次第... https://www.gatsbyjs.com/docs/using-graphql-fragments/
gatsby-typescript-starter で setup してみよかなと思ったけど、いきなり compile error 出るしやる気なくす

## Coverage 周り

v8 coverage について調べだす https://v8.dev/blog/javascript-code-coverage
v8 の coverage は best-effort と precise の 2 種類.
puppeteer は precise の方 https://github.com/puppeteer/puppeteer/blob/main/src/common/Coverage.ts#L210
puppeteer の coverage は https://github.com/istanbuljs/puppeteer-to-istanbul で istanbul report に変換できる
sourcemap これでいける？ https://github.com/istanbuljs/puppeteer-to-istanbul/issues/18
nyc の report コマンドで、istanbul の生データから各種レポート生成ができる https://github.com/istanbuljs/nyc

## Others

OSS 周りのエゴサ用のクエリメンテ。

fugitive の Gbrowse ちゃんと使いたくて https://github.com/tpope/vim-rhubarb 入れる。
`let g:github_enterprise_urls = ['https://hoge.ghe.com']` 的な感じで GitHub Enterprise も問題ない。

https://keleshev.com/compiling-to-assembly-from-scratch/ という ARM 向け small compiler を実装する本を買う。

jset + AWS CodeBuild で coverage report するやつ https://docs.aws.amazon.com/codebuild/latest/userguide/test-report-jest.html

---

# 9/29

## Coverage 周り

https://github.com/Quramy/puppeteer-coverage-study で Puppeteer + SourceMap 付き Coverage 収集の PoC をやってみる。

https://github.com/istanbuljs/v8-to-istanbul を使えば、source map も対応してる、という @bcoe 書き込みを見るも、うまくいかず

本来実行されていないハズの block が実行されているようになっている。そもそも、同一の script であっても、Node.js で `NODE_V8_COVERAGE` 付けて取った V8 coverage と、Puppeteer(CDP)で取得した Coverage の range が全く違うように見える。
Node.js の方はちゃんと block 単位(関数単位？)で range の出力がされているようだが、CDP の出力はどうも違うよう。

CDP 出力の range の方が幅広く、source map と突き合わせた際に、original source には存在しない行とそうじゃない行がごちゃまぜになっていく？この辺りはよくわからない

いずれにせよ、v8-to-istanbul に頼るのは諦めて、自分で SourceMap と CDP の Coverage を突き合わせて istanbul 形式に変換することを考えた方が良さそう

istanbul の出力形式を読みだす。

- statement, branch, function のそれぞれについて、ソースコードとの位置づけの map がある. map の key は数値なので、ほぼ配列
- 各種別について、s, b, f という key で、それぞれが何回実行されたかの map をもっっている
- location 情報は、line & col 形式、line は 1-starting-index, col は 0-starting-index (ちょっと不思議だ) -> source-map の rule も一緒だし、この界隈だとそうなのかも？

statement だけなら簡単にできそうな気がしてきたぞ

playwright の方が coverage はよさそう？V8 のモノに近いようにみえる。これなら、そのまま v8-to-istanbul が使えそうだし。https://playwright.dev/#version=v1.4.2&path=docs%2Fapi.md&q=chromiumcoveragestopjscoverage

## SourceMap

coverage やるなら、sourcemap も避けて通れなさそう。https://sourcemaps.info/spec.html
mapping encoding が結局よくわからんなって思ってたけど、これぞ求めていた良記事: http://safx-dev.blogspot.com/2013/08/javascriptsource-map.html

相当する実装は https://github.com/mozilla/source-map
