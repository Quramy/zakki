# 9/1

## WebAssembly

@yosuke_furukawa さんに共有してもらった WASM の文字列に関する記事

https://medium.com/wasm/strings-in-webassembly-wasm-57a05c1ea333

軽く眺めた感じ、Rust の wasm-bindgen の Getting Started 的な色合いが強く、Canonical ABI や Interface Types についての話はあまり言及されていなさそう。

あんまりまだ Canonical ABI がわかってないんだけど、"ABI" というからには「WASM の Module を使う側で lift などをしろよ」という話なので、まさに bindgen がやっていることが当面の仕様になるんじゃね？と思ってるんだけど、この辺りの理解があっているかの答え合わせになっているんだろうか。

---

# 9/2

## reg

同僚からの報告にて。どうも reg-cli の v0.18.x でバグがあるっぽい。というか、連携されたレポート画面の URL 確認したらダイアログが立ち上がらない状況になってた。

---

# 9/3

## node-fetch

node-fetch v3 が知れっと出ていたけど、違いとして、以下がある、という話を会社できいた。

- WHATWG URL を利用するようになった
- timeout option が廃止されて、AbortController 利用が必須になった

そういえば AbortController 全然わかってないな。。。

---

# 9/7

## CSS

backdrop がある Overlay 系の CSS について。

そもそもこの手の CSS 書く機会が年に 1, 2 回あるかどうか程度なんだけど、毎回 「backdrop 透過して scroll が伝播する」という件の対処方法を忘れる。

https://css-tricks.com/prevent-page-scrolling-when-a-modal-is-open/

まずは `overflow-y` 使うパターン。

```css
body {
  overflow-y: auto;
}

body.modal-open {
  overflow-y: hidden;
  padding-right: 15px; /* reflow を防ぐため */
}
```

backdrop 描画したときに、body に `addClass`して scroll 抑止する。これは一見上手く動くし、割と簡単なんだけど、 iOS デバイスだと不十分。

### Rails

手元の database がにっちもさっちも行かなくなったときに以下で reset しつつ、migration を 1 から実行できることを知った。

```sh
rake db:migrate:reset
```

database の削除だけを実行したい場合、

```sh
rake db:drop
```

---

# 9/8

## CSS

SP で所謂 "Pull-to-Refresh" 的な操作をやられたときに起こる「スクロール可能な位置よりもさらに引っ張る」のような操作をされた場合に「引っ張られたコンテンツが`positino: fixed` な FAB 系のコンテンツとぶつかってしまい見栄えが悪い」という相談を受けた。

結局、対処方法は何も出てこなかったんだけど、この話を聞く過程で「スクロール可能な位置よりもさらに引っ張る」ときの挙動が CSS で制御できることを知る。

```css
.hoge {
  overscroll-behavior: none;
}
```

ただ、2021 年現在だと、iOS Safari が未対応なので、あんまり意味のない情報なんだけども(vendor-prefix もないっぽい)

https://caniuse.com/mdn-css_properties_overscroll-behavior

どうでもいいけど、`scroll-behavior` と紛らわしい

## Next.js

社内の Next.js 研修資料を勝手に眺めていたときに "granular chunking" というキーワードが気になったので調べる。適当にググったら web.dev が出てきた。

https://web.dev/granular-chunking-nextjs/

複数ページで共有されるような `common.js` にまとめるような戦略をより効率的にきめ細かくやろうぜ、という類の話っぽい。

## Misc

ようやく GitHub が 365 streak になったー :tada:

---

# 9/9

## JavaScript

`Object.is` と `NaN` の話を聞く。

https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/is#using_object.is

細かくて、毎回叩きながら思い出してるやつだ。。。

```js
console.log(0 / 0 === NaN); // false
console.log(Object.is(0 / 0, NaN)); // true
```

## Storybook

https://storybook.js.org/docs/react/configure/environment-variables

Storybook で env value を設定したときに、下記のように `%` で値を囲むと環境変数の Placehold ができるのね。。。

```html
<link rel="stylesheet" href="%STORYBOOK_STYLE_URL%" />
```

HTML 中での置換は Storybook 本体というよりも何かしらの loader の機能だと思うんだけど、Storybook 文脈だと Deploy 先に合わせて base path 変えたい、というのはよくあるユースケースなので、知っておくと便利そう。

---

# 9/10

## Misc

「ジュニアなメンバーを育てる」とはどういうことだろう、とモヤモヤ考え続けた日になった。

---

# 9/13

## Passport

何度か Passport で OAuth2 連携しているコードは読んだことがあったけど、自分で 1 から書いたのはこれが初めてだった。一発目の疎通確認まででちょっとハマったのでメモっておく。

基本的には [公式 Docs](http://www.passportjs.org/packages/passport-oauth2/) を読めば事足りる内容ではある。

```ts
import express from "express";
import passport from "passport";
import { Strategy } from "passport-oauth2";

const app = express();

passport.use(
  "my-oauth2",
  new Strategy(
    {
      clientID: EXAMPLE_CLIENT_ID,
      clientSecret: EXAMPLE_CLIENT_SECRET,
      authorizationURL: "https://www.example.com/oauth2/authorize", // 認証エンドポイント
      callbackURL: "http://localhost:3000/auth/callback" // ログイン後に Authorization Code を受け取る callback URL
      tokenURL: "https://www.example.com/oauth2/token", // Token 交換用のエンドポイント
    },
    (
      accessToken: string,
      refreshToken: string,
      _profile: unknown,
      done: (err: any, passportUser: any) => void
    ) => {
      // 必要に応じて、ここに AccessToken の検証処理を書く

      // 正常時は done の第2引数に User となる情報を渡しておく
      done(null, {
        accessToken,
        refreshToken
      });
    }
  )
);

app.use(passport.initialize());

// Client としての認証エンドポイント
app.get("/auth/login", passport.authenticate("my-oauth2"));

// Callback を受け付ける部分
app.get(
  "/auth/callback",
  passport.authenticate("my-oauth2", { failureRedirect: "/auth/login" }),
  (_, res) => res.redirect("/mypage")
);

app.listen(3000)
```

認証も認証 callback も `passport.authenticate` で提供される Middleware、というのはどうにも釈然としない気持ちがある。

---

# 9/14

## Apollo

「mutation を発火させたら Cache を invalidate する」というのをやってみた。

[InMemoryCache における evict の docs](https://www.apollographql.com/docs/react/api/cache/InMemoryCache/#evict) を読んだところ、引数の Object における `fieldName` をセットしなければ Cache 全体を invalidate するのと同じ動きになる模様。

後は、`client.mutate` そのものを proxy して、この `cache.evict` を叩くようにすれば完成？

```ts
export class CustomizedApolloClient<
  TCacheShape
> extends ApolloClient<TCacheShape> {
  async mutate<T = any, TVariables = OperationVariables>(
    options: MutationOptions<T, TVariables>
  ) {
    const result = await super.mutate(options);
    this.cache.evict({});
    return result;
  }
}
```

しばらくお仕事の案件の開発環境に放り込んで動き観察してみるか。

## npm

npm workspaces、mono repos には便利なのだけど、実際に業務で向き合うと色々詰まるところがある。

一つ一つはシンプルな問題を解決しようとしているものの、開発におけるコンテキストが色々あるせいで、環境構築が難しく且つ属人化し、後進が読み解きにくくなってしまう。

現状で取り組んでいるのは、「複数の Custom Server な Next.js のパッケージ + それらが共通で利用する Component や関数をまとめた package」という構成の mono repos。雑に書くと以下のような構成になる。

```
<repository root> /
  node_modules/
  packages /
    - next-app-A /
        src /
          express/
            server.ts
          pages /
            index.tsx
          components /
        next.config.js
        tsconfig.json
        package.json
    - next-app-B /
        src /
          express/
            server.ts
          pages /
            index.tsx
          components /
        next.config.js
        tsconfig.json
        package.json
    - shared /
        lib /
          components /
            Button.tsx
        tsconfig.json
        package.json
  tsconfig.json
  package.json
  package-lock.json
```

TypeScript + npm workspaces が基本構成なので、以前に作成した https://github.com/Quramy/npm-ts-workspaces-example をベースとして構築している。

GitHub にあげたサンプルと比べて手間だった部分として、「`next-app-A` から、`<Button>` を利用したい」という目的に対して、

```tsx
import { Button } from "shared/lib/components/Button";
```

のようにバレルせずに書こうとすると、以下の事象が発生する

- `tsc -b` に `--noEmit` が渡せないため、Button.js というファイルができてしまう

もちろん、バレルにすれば `srcDir` と `outDir` でフォルダを分けれるのだけど、↓ のように書くことになるし、お仕事でのプロジェクトとなると、shared に含まれる export 対象もそこそこの数になってしまうので、避けたかったというのがある。

```tsx
import { Button } from "shared";
```

仕方なく、CI での static check では `tsc -b --outDir=".built"` のようにし、Dockerfile などでは `tsc -b --outDir="."` のようにすることで回避した。

- IDE での package 跨ぎでの Go to definition
- フォルダ単位での ignore (.dockerignore や.gitignore, .prettierignore など)の書きやすさ

にトレードオフが発生するような構造になってしまう。

---

# 9/15

## Docker

今まで脳死で `node:16-alpine` を使っていたけど、最近は -slim ベースでもそこそこ image size が減ってきたらしい。一々 apk 使ったりするのが面倒というのもあったので、覚えておくようにする。

---

# 9/16

## React.js

tooltip 系組むときに使えそうなやつ

https://www.npmjs.com/package/rc-trigger

と思ったが、Example が release されている version と比較して古いく、hover out したときの動作が期待と異なる(hover out 時に消えてほしいが、そうはならない)というのもあり、信頼できない気持ちになったため利用はしない。

## TypeScript

https://devblog.thebase.in/entry/typescript-compiler-api-storybook

Compiler API の事例・解説。あんまりこの手のヤツ世の中に出てこないのでよき。

---

# 9/17

## Figma

画面右上の拡大縮小率変更するところから、Grid Layout の表示非表示を切り替えられるのを教えてもらった。

ショートカットキーだと `Ctrl + G` で toggle できる。

Chrome dev tool の "Grid" ってラベルをポチポチするのと同じような効果。

## React.js

同僚である @sangotaro さんの記事。

https://qiita.com/sangotaro/items/3ea63110517a1b66745b

children の型など、ちゃんと書いてあって、他の人に教えるときに reference としてとてもよき。

## Styled Components

やっぱりこれも同僚である @takepepe さんの記事。

https://qiita.com/Takepepe/items/41e3e7a2f612d7eb094a

```tsx
const Root = styled.div`
  & > button {
    color: red;
  }
`;
```

的な記載方法を推奨してんの、割と珍しいんだよな。個人的に要素追加するたびに `styled.div` とかしていくのあまり好きじゃないので、上記のような記法の方がよい。
